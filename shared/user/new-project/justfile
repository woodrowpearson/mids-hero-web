# Claude Code Optimized Justfile
# Focused on context management and AI-assisted development

set shell := ["bash", "-euo", "pipefail", "-c"]
set dotenv-load := true
set positional-arguments := true

# Configuration
project_root := justfile_directory()
python_version := env_var_or_default("PYTHON_VERSION", "3.11")
venv_name := env_var_or_default("VENV_NAME", ".venv")

# Colors for output
export BOLD := '\033[1m'
export RESET := '\033[0m'
export GREEN := '\033[32m'
export YELLOW := '\033[33m'
export RED := '\033[31m'

# Default - show available commands
default:
    @just --list --justfile {{justfile()}}

# === Quick Start ===

# Complete setup for new developers
quickstart: install-tools setup
    @echo "âœ… Development environment ready!"
    @echo "ğŸš€ Run 'just dev' to start development"

# Install required tools
install-tools:
    @echo "ğŸ”§ Checking required tools..."
    @command -v python3 >/dev/null || echo "âš ï¸  Please install Python {{python_version}}"
    @command -v git >/dev/null || echo "âš ï¸  Please install Git"
    @echo "âœ… Tools check complete"

# Setup project environment
setup: venv install
    @echo "âœ… Project setup complete"

# Create virtual environment
venv:
    @echo "ğŸ Creating virtual environment..."
    python{{python_version}} -m venv {{venv_name}}
    @echo "âœ… Virtual environment created"

# Install dependencies
install:
    @echo "ğŸ“¦ Installing dependencies..."
    {{venv_name}}/bin/pip install --upgrade pip
    {{venv_name}}/bin/pip install -r requirements.txt
    @echo "âœ… Dependencies installed"

# === Context Management ===

# Check context health
context-health:
    @echo "ğŸ¥ Checking context health..."
    {{venv_name}}/bin/python scripts/context/context_health_monitor.py

# Analyze context sizes
context-analyze:
    @echo "ğŸ“Š Analyzing context sizes..."
    {{venv_name}}/bin/python scripts/context/measure_context_complexity.py

# Prune oversized contexts
context-prune:
    @echo "âœ‚ï¸ Pruning contexts..."
    {{venv_name}}/bin/python scripts/context/context_pruning.py --auto

# Monitor token usage
token-monitor:
    @echo "ğŸ”¤ Monitoring token usage..."
    {{venv_name}}/bin/python scripts/context/analyze_token_usage.py --watch

# Full context optimization
optimize-context: context-analyze context-prune token-monitor
    @echo "âœ… Context optimization complete"

# Resume context management session
context-resume:
    @echo "ğŸ”„ Resuming context management..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @if [ -f ".claude/shared/memory/session.json" ]; then \
        {{venv_name}}/bin/python scripts/context/load_session.py; \
    else \
        echo "  â€¢ No active session found"; \
    fi
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# === Development ===

# Start development server
dev:
    @echo "ğŸš€ Starting development server..."
    {{venv_name}}/bin/python -m app.main

# Run with custom port
dev-port port="8000":
    @echo "ğŸš€ Starting on port {{port}}..."
    {{venv_name}}/bin/python -m app.main --port {{port}}

# Run with debugger
dev-debug:
    @echo "ğŸ› Starting with debugger..."
    {{venv_name}}/bin/python -m debugpy --listen 5678 --wait-for-client -m app.main

# === Testing ===

# Run all tests
test:
    @echo "ğŸ§ª Running tests..."
    {{venv_name}}/bin/pytest

# Run tests matching pattern
test-match pattern:
    @echo "ğŸ§ª Running tests matching '{{pattern}}'..."
    {{venv_name}}/bin/pytest -k {{pattern}}

# Run tests with coverage
test-cov:
    @echo "ğŸ“Š Running tests with coverage..."
    {{venv_name}}/bin/pytest --cov=. --cov-report=html

# === Code Quality ===

# Run all quality checks
quality: format lint typecheck
    @echo "âœ… Quality checks passed"

# Format code
format:
    @echo "âœ¨ Formatting code..."
    {{venv_name}}/bin/black .
    {{venv_name}}/bin/isort .

# Run linting
lint:
    @echo "ğŸ” Linting code..."
    {{venv_name}}/bin/flake8 .

# Run type checking
typecheck:
    @echo "ğŸ” Type checking..."
    {{venv_name}}/bin/mypy .

# === Git Workflows ===

# Create feature branch
feature name:
    @echo "ğŸŒ¿ Creating feature branch..."
    git checkout main && git pull
    git checkout -b feature/{{name}}

# Quick commit and push
ucp message:
    @echo "ğŸ“ Committing and pushing..."
    git add -A
    git commit -m "{{message}}"
    git push

# === Agent Development ===

# Initialize new agent
init-agent name:
    @echo "ğŸ¤– Creating agent: {{name}}"
    mkdir -p .claude/agents/{{name}}
    cp .claude/templates/specialized-agent.md .claude/agents/{{name}}/instructions.md
    @echo "âœ… Agent {{name}} initialized"

# Run agent with monitoring
run-agent name task:
    @echo "ğŸš€ Running agent {{name}}"
    just context-health
    {{venv_name}}/bin/python scripts/agents/run_agent.py --agent {{name}} --task "{{task}}"

# === Progress Tracking ===

# Update progress
progress-update task="" status="":
    @echo "ğŸ“Š Updating progress..."
    @if [ -n "{{task}}" ]; then \
        {{venv_name}}/bin/python scripts/context/update_progress.py --task "{{task}}" --status "{{status}}"; \
    else \
        {{venv_name}}/bin/python scripts/context/update_progress.py; \
    fi

# === Utilities ===

# Create scratch workspace
scratch name:
    @echo "ğŸ§ª Creating scratch workspace..."
    mkdir -p .agent-scratch/{{name}}
    @echo "Created: .agent-scratch/{{name}}"

# View logs
logs n="50" pattern="":
    @echo "ğŸ“œ Viewing logs..."
    @if [ -n "{{pattern}}" ]; then \
        tail -n {{n}} logs/*.log | grep -i "{{pattern}}"; \
    else \
        tail -n {{n}} logs/*.log; \
    fi

# Clean generated files
clean:
    @echo "ğŸ§¹ Cleaning..."
    trash __pycache__ .pytest_cache .coverage htmlcov 2>/dev/null || true
    fd -t f -e pyc -x trash {} \;
    @echo "âœ… Clean complete"

# Show environment info
env-info:
    @echo "ğŸ“‹ Environment Information"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "Project: {{project_root}}"
    @echo "Python: $({{venv_name}}/bin/python --version)"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# === Health & Validation ===

# Run health checks
health:
    @echo "ğŸ¥ Running health checks..."
    {{venv_name}}/bin/python scripts/health_check.py

# Run all validation
validate: lint typecheck test
    @echo "âœ… All validation passed"

# === CI/CD ===

# Run CI pipeline locally
ci: install quality test
    @echo "âœ… CI pipeline passed"

# Build for production
build:
    @echo "ğŸ—ï¸ Building..."
    {{venv_name}}/bin/python -m build

# === Documentation ===

# Serve documentation
docs:
    @echo "ğŸ“š Serving documentation..."
    {{venv_name}}/bin/mkdocs serve

# === Shortcuts ===

# Aliases for common commands
d: dev
t: test
q: quality
c: clean