# Epic 2.1: Archetype & Origin Selection - Detailed Implementation Plan

**Date**: 2025-11-16
**Epic**: 2.1 - Archetype & Origin Selection
**Status**: Planning
**MidsReborn Analysis**: docs/frontend/analysis/MIDSREBORN-UI-ANALYSIS-epic-2.1.md

---

## Background & Context

### Epic Objectives

From epic-breakdown.md, Epic 2.1 aims to implement the initial character creation flow:
- Create archetype selector component
- Create origin selector component
- Create alignment selector component
- Create character name input
- Integrate with character store

### MidsReborn Reference

From MIDSREBORN-UI-ANALYSIS-epic-2.1.md:
- Character creation handled in `frmMain.cs` top panel
- Compact layout with Name (TextBox), Archetype (ComboBox), Origin (ComboBox)
- Alignment managed via toggle button (Hero/Villain/Vig/Rogue)
- Real-time updates to Character object
- Archetype change resets incompatible powersets (with confirmation)
- Origin limited to archetype's allowed origins

### Previous Epic

Epic 1.3 completed:
- BuildLayout component with 2-6 column grid
- TopPanel for character info display
- SidePanel for character creation controls (Epic 2.x will populate this)
- UIStore for layout preferences
- CharacterStore foundation (Epic 1.2)

### Architecture Decisions

- **Framework**: Next.js 14 (App Router), React 19
- **UI Library**: shadcn/ui + Tailwind CSS
- **State Management**: TanStack Query (server) + Zustand (client)
- **Testing**: Vitest + React Testing Library

---

## Component Specifications

### 1. CharacterNameInput Component

**File**: `frontend/src/components/character/CharacterNameInput.tsx`

**Purpose**: Text input for character name with label

**Props**:
```typescript
interface CharacterNameInputProps {
  value: string;
  onChange: (name: string) => void;
  className?: string;
}
```

**UI Design**:
- shadcn/ui Input component
- Label: "Name"
- Placeholder: "Enter character name"
- No validation (any string accepted)
- Real-time updates to store

**State Management**:
- Reads from: `characterStore.name`
- Updates via: `characterStore.setName(value)`

**Example**:
```tsx
<CharacterNameInput
  value={characterStore.name}
  onChange={(name) => characterStore.setName(name)}
/>
```

**Tests** (`CharacterNameInput.test.tsx`):
- Renders with label and input
- Displays current value
- Calls onChange on input
- Updates store on change

---

### 2. ArchetypeSelector Component

**File**: `frontend/src/components/character/ArchetypeSelector.tsx`

**Purpose**: Dropdown selector for archetype with search, icons, and info display

**Props**:
```typescript
interface ArchetypeSelectorProps {
  value: Archetype | null;
  onChange: (archetype: Archetype) => void;
  className?: string;
}
```

**UI Design**:
- shadcn/ui Select component with Command (search)
- Label: "Archetype"
- Placeholder: "Select archetype"
- Display: Archetype icon + displayName
- Search: Filter by archetype name
- Info popover: Show description, inherent powers on hover/click

**Data Source**:
- TanStack Query: `useArchetypes()` hook
- Fetches from: `GET /api/archetypes`
- Cache: Forever (static game data)

**State Management**:
- Reads from: `characterStore.archetype`
- Updates via: `characterStore.setArchetype(archetype)`

**Behavior**:
- On change:
  - If powersets selected, show confirmation dialog: "Changing archetype will reset your power selections. Continue?"
  - If confirmed, call `setArchetype()` which clears powersets
  - Reset origin to first allowed origin

**TypeScript Types**:
```typescript
interface Archetype {
  idx: number;
  displayName: string;
  className: string;
  descLong: string;
  descShort: string;
  origin: string[]; // Allowed origins
  primary: number[]; // Allowed primary powersets
  secondary: number[]; // Allowed secondary powersets
  classType: string; // "Hero", "Villain", "HeroEpic", "VillainEpic"
  // Modifiers & Caps
  hitpoints: number;
  hpCap: number;
  damageCap: number;
  resCap: number;
  baseRegen: number;
  // Icon (if available)
  icon?: string;
}
```

**Tests** (`ArchetypeSelector.test.tsx`):
- Renders with label and select
- Displays current archetype
- Fetches archetypes from API
- Shows archetype options in dropdown
- Calls onChange on selection
- Shows confirmation when powersets exist
- Displays archetype info in popover

---

### 3. OriginSelector Component

**File**: `frontend/src/components/character/OriginSelector.tsx`

**Purpose**: Dropdown selector for origin (enabled after archetype selected)

**Props**:
```typescript
interface OriginSelectorProps {
  value: string | null; // Origin name
  archetype: Archetype | null;
  onChange: (origin: string) => void;
  className?: string;
}
```

**UI Design**:
- shadcn/ui Select component
- Label: "Origin"
- Placeholder: "Select origin"
- Display: Origin icon + name
- Disabled: When no archetype selected
- Options: Filtered to archetype's allowed origins

**Data Source**:
- Origins list from selected archetype: `archetype.origin[]`
- Default origins: Magic, Mutation, Natural, Science, Technology

**State Management**:
- Reads from: `characterStore.origin`
- Updates via: `characterStore.setOrigin(origin)`

**Behavior**:
- Disabled if `archetype === null`
- When archetype changes, reset to first allowed origin
- No confirmation needed (origin is cosmetic)

**TypeScript Types**:
```typescript
type Origin = "Magic" | "Mutation" | "Natural" | "Science" | "Technology";
```

**Tests** (`OriginSelector.test.tsx`):
- Renders with label and select
- Displays current origin
- Disabled when no archetype
- Shows only archetype's allowed origins
- Calls onChange on selection

---

### 4. AlignmentSelector Component

**File**: `frontend/src/components/character/AlignmentSelector.tsx`

**Purpose**: Radio group or toggle group for alignment selection

**Props**:
```typescript
interface AlignmentSelectorProps {
  value: Alignment | null;
  onChange: (alignment: Alignment) => void;
  className?: string;
}
```

**UI Design**:
- shadcn/ui RadioGroup or ToggleGroup
- Label: "Alignment"
- Options: Hero, Villain, Vigilante, Rogue
- Display: Icons + labels (hero blue, villain red, etc.)
- Default: Hero (or auto-set from archetype)

**State Management**:
- Reads from: `characterStore.alignment`
- Updates via: `characterStore.setAlignment(alignment)`

**Behavior**:
- Auto-sets when archetype selected based on `archetype.classType`
- User can override default alignment
- Changes UI theme colors (future enhancement)

**TypeScript Types**:
```typescript
type Alignment = "Hero" | "Villain" | "Vigilante" | "Rogue";
```

**Tests** (`AlignmentSelector.test.tsx`):
- Renders with label and options
- Displays current alignment
- Calls onChange on selection
- Auto-sets from archetype

---

### 5. ArchetypeInfoDisplay Component

**File**: `frontend/src/components/character/ArchetypeInfoDisplay.tsx`

**Purpose**: Card displaying archetype description, inherent powers, modifiers, and caps

**Props**:
```typescript
interface ArchetypeInfoDisplayProps {
  archetype: Archetype | null;
  className?: string;
}
```

**UI Design**:
- shadcn/ui Card component
- Sections:
  - **Description**: `archetype.descLong`
  - **Inherent Powers**: List of inherent powers (from archetype data)
  - **Modifiers**: Damage scale, buff/debuff mods
  - **Caps**: HP cap, damage cap, resistance cap, regen cap
- Empty state: "Select an archetype to see details"

**Data Source**:
- Props: `archetype` object from parent

**State Management**:
- Read-only display (no state updates)

**Tests** (`ArchetypeInfoDisplay.test.tsx`):
- Renders empty state when no archetype
- Displays archetype description
- Shows inherent powers list
- Shows modifiers and caps

---

### 6. CharacterCreationPanel Component

**File**: `frontend/src/components/character/CharacterCreationPanel.tsx`

**Purpose**: Container component combining all character creation controls

**Props**:
```typescript
interface CharacterCreationPanelProps {
  className?: string;
}
```

**UI Design**:
- Vertical stack layout (matches MidsReborn top panel)
- Components in order:
  1. CharacterNameInput
  2. ArchetypeSelector
  3. OriginSelector
  4. AlignmentSelector
  5. ArchetypeInfoDisplay

**State Management**:
- Reads from: `characterStore`
- Passes state to child components
- Handles coordination (archetype changes reset origin)

**Example**:
```tsx
function CharacterCreationPanel() {
  const { name, archetype, origin, alignment, setName, setArchetype, setOrigin, setAlignment } = useCharacterStore();

  return (
    <div className="space-y-4 p-4">
      <CharacterNameInput value={name} onChange={setName} />
      <ArchetypeSelector value={archetype} onChange={setArchetype} />
      <OriginSelector value={origin} archetype={archetype} onChange={setOrigin} />
      <AlignmentSelector value={alignment} onChange={setAlignment} />
      <ArchetypeInfoDisplay archetype={archetype} />
    </div>
  );
}
```

**Tests** (`CharacterCreationPanel.test.tsx`):
- Renders all child components
- Coordinates state between components
- Resets origin when archetype changes

---

## State Management Plan

### CharacterStore Updates

**File**: `frontend/src/stores/characterStore.ts`

**Current State** (from Epic 1.2):
```typescript
interface CharacterState {
  // Existing fields...
  name: string;
  archetype: Archetype | null;
  origin: Origin | null;
  alignment: Alignment | null;
  // ... other fields
}
```

**New Actions**:
```typescript
setArchetype: (archetype: Archetype | null) => void;
setOrigin: (origin: string | null) => void;
setAlignment: (alignment: Alignment | null) => void;
```

**Enhanced setArchetype Implementation**:
```typescript
setArchetype: (archetype) => {
  set((state) => {
    // If archetype changes and powersets are selected, clear them
    if (state.archetype?.idx !== archetype?.idx && state.powers.length > 0) {
      // Confirmation handled in UI component
      return {
        archetype,
        origin: archetype?.origin[0] || null, // Reset to first allowed origin
        // Clear powersets (Epic 2.2 concern)
      };
    }
    return {
      archetype,
      origin: archetype?.origin[0] || null,
    };
  });
}
```

**Persistence**:
- Already configured with Zustand persist middleware (Epic 1.2)
- Character creation selections persist to localStorage

---

## API Integration Plan

### Endpoint 1: GET /api/archetypes

**Purpose**: Fetch all playable archetypes

**Status**: ✅ Already implemented in backend

**Request**:
```
GET /api/archetypes
```

**Response**:
```typescript
Archetype[] // Array of archetype objects
```

**TanStack Query Hook**:
```typescript
// frontend/src/hooks/useArchetypes.ts
import { useQuery } from '@tanstack/react-query';

export function useArchetypes() {
  return useQuery({
    queryKey: ['archetypes'],
    queryFn: () => fetch('/api/archetypes').then(r => r.json()),
    staleTime: Infinity, // Static game data
  });
}
```

**Tests** (`useArchetypes.test.ts`):
- Fetches archetypes from API
- Caches data correctly
- Returns loading state
- Handles errors

---

### Endpoint 2: Origins Data

**Decision**: Origins are derived from archetype data (`archetype.origin[]`), no separate endpoint needed.

**Alternative**: If origins need rich data (descriptions, bonuses), create `GET /api/origins` endpoint.

For Epic 2.1, we'll use archetype-derived origins (simpler).

---

## Implementation Tasks

### Task 1: Update CharacterStore
**File**: `frontend/src/stores/characterStore.ts`

- Add `setArchetype` implementation with origin reset logic
- Add `setOrigin` implementation
- Add `setAlignment` implementation
- Add tests for new actions

**Tests**:
- `characterStore.test.ts`:
  - `setArchetype` updates archetype and resets origin
  - `setOrigin` updates origin
  - `setAlignment` updates alignment
  - State persists to localStorage

---

### Task 2: Create useArchetypes Hook
**File**: `frontend/src/hooks/useArchetypes.ts`

- Create TanStack Query hook for archetype fetching
- Configure caching (staleTime: Infinity)
- Add error handling
- Add tests

**Tests**:
- `useArchetypes.test.ts`:
  - Fetches from /api/archetypes
  - Returns loading state
  - Returns data on success
  - Handles errors gracefully

---

### Task 3: Create CharacterNameInput Component
**File**: `frontend/src/components/character/CharacterNameInput.tsx`

- Create component with shadcn/ui Input
- Add label
- Wire to characterStore
- Add tests

**Tests**:
- `CharacterNameInput.test.tsx`:
  - Renders label and input
  - Displays current value
  - Updates on input change
  - Calls onChange handler

---

### Task 4: Create ArchetypeSelector Component
**File**: `frontend/src/components/character/ArchetypeSelector.tsx`

- Create component with shadcn/ui Select + Command
- Add search functionality
- Add archetype info popover
- Add confirmation dialog for archetype change
- Wire to useArchetypes hook and characterStore
- Add tests

**Tests**:
- `ArchetypeSelector.test.tsx`:
  - Renders select with archetypes
  - Filters archetypes on search
  - Shows confirmation when changing with powersets
  - Updates characterStore on selection
  - Displays archetype info

---

### Task 5: Create OriginSelector Component
**File**: `frontend/src/components/character/OriginSelector.tsx`

- Create component with shadcn/ui Select
- Filter origins by archetype
- Disable when no archetype
- Wire to characterStore
- Add tests

**Tests**:
- `OriginSelector.test.tsx`:
  - Renders disabled when no archetype
  - Shows archetype's allowed origins
  - Updates characterStore on selection

---

### Task 6: Create AlignmentSelector Component
**File**: `frontend/src/components/character/AlignmentSelector.tsx`

- Create component with shadcn/ui RadioGroup or ToggleGroup
- Add icons for each alignment
- Wire to characterStore
- Add tests

**Tests**:
- `AlignmentSelector.test.tsx`:
  - Renders all alignment options
  - Updates characterStore on selection
  - Auto-sets from archetype

---

### Task 7: Create ArchetypeInfoDisplay Component
**File**: `frontend/src/components/character/ArchetypeInfoDisplay.tsx`

- Create component with shadcn/ui Card
- Display description, inherent powers, modifiers, caps
- Handle empty state
- Add tests

**Tests**:
- `ArchetypeInfoDisplay.test.tsx`:
  - Shows empty state when no archetype
  - Displays archetype details
  - Shows inherent powers
  - Shows modifiers and caps

---

### Task 8: Create CharacterCreationPanel Component
**File**: `frontend/src/components/character/CharacterCreationPanel.tsx`

- Create container component
- Compose all child components
- Handle coordination logic
- Add tests

**Tests**:
- `CharacterCreationPanel.test.tsx`:
  - Renders all child components
  - Coordinates state updates
  - Resets origin when archetype changes

---

### Task 9: Integrate into Builder Page
**File**: `frontend/src/app/builder/page.tsx`

- Add CharacterCreationPanel to SidePanel
- Verify layout works with BuildLayout
- Test responsive behavior

---

### Task 10: Run All Tests & Quality Checks
- Run `npm test` - Ensure all tests pass
- Run `npm run lint` - Fix any linting errors
- Run `npm run build` - Ensure build succeeds
- Manual test in browser

---

## Acceptance Criteria

### Functional

✅ Character name input updates store in real-time
✅ Archetype selector fetches and displays all playable archetypes
✅ Archetype selection updates store and resets origin
✅ Origin selector shows only archetype's allowed origins
✅ Origin selector disabled when no archetype
✅ Alignment selector updates store
✅ Archetype info displays description, inherents, modifiers, caps
✅ All selections persist across page refreshes (localStorage)
✅ Changing archetype with powersets shows confirmation (Epic 2.2 dependency)

### Visual

✅ Components match MidsReborn functional layout
✅ Modern web aesthetic (not pixel-perfect copy)
✅ Icons display for archetypes and origins
✅ Responsive on mobile/tablet/desktop
✅ Smooth transitions and interactions

### Technical

✅ All TypeScript strict mode compliant (no `any`)
✅ All tests passing (>80% coverage)
✅ ESLint and Prettier passing
✅ No console errors or warnings
✅ TanStack Query caching working correctly
✅ Zustand persistence working correctly

---

## Visual Verification Checklist

After implementation, verify against MidsReborn:

- [ ] Run dev server: `cd frontend && npm run dev`
- [ ] Navigate to `/builder`
- [ ] Open character creation panel in SidePanel
- [ ] Test character name input
- [ ] Test archetype selection (dropdown, search, info display)
- [ ] Test origin selection (enabled after archetype)
- [ ] Test alignment selection
- [ ] Capture screenshot: `docs/frontend/screenshots/implementation-character-creation-epic-2.1.png`
- [ ] Compare with MidsReborn: `shared/user/midsreborn-screenshots/mids-new-build.png`
- [ ] Verify functional parity (not pixel-perfect)

**Verification Checklist**:
- [ ] Name input works
- [ ] Archetype dropdown displays all ATs
- [ ] Archetype info shows on selection
- [ ] Origin dropdown enabled after AT selection
- [ ] Origin limited to AT's allowed origins
- [ ] Alignment selector works
- [ ] All selections persist on page reload
- [ ] No console errors

---

## Dependencies

### From Previous Epics

- ✅ Epic 1.2: CharacterStore foundation
- ✅ Epic 1.3: BuildLayout, SidePanel

### Backend API

- ✅ `GET /api/archetypes` - Already implemented

### shadcn/ui Components

Install if not already present:
```bash
npx shadcn-ui@latest add input
npx shadcn-ui@latest add select
npx shadcn-ui@latest add radio-group
npx shadcn-ui@latest add card
npx shadcn-ui@latest add dialog
npx shadcn-ui@latest add popover
npx shadcn-ui@latest add command
```

---

## Next Epic Preview

**Epic 2.2**: Powerset Selection

Will build on Epic 2.1:
- Use selected archetype to filter available powersets
- Primary powerset selector (filtered by `archetype.primary[]`)
- Secondary powerset selector (filtered by `archetype.secondary[]`)
- Pool power selectors (4 slots)
- Ancillary/Epic selector

**Prerequisites Met**:
- ✅ Archetype selected (Epic 2.1)
- ✅ CharacterStore ready for powersets
- ✅ Layout ready for powerset UI

---

## Key Design Decisions

### 1. Archetype Data Source

**Decision**: Fetch from `/api/archetypes` endpoint

**Rationale**: Backend already implements archetype endpoint with full data (modifiers, caps, allowed powersets). No need to duplicate data in frontend.

### 2. Origin Data Source

**Decision**: Derive from archetype data (`archetype.origin[]`)

**Rationale**: Origins are archetype-specific in MidsReborn. Simpler to use archetype's allowed origins than create separate endpoint.

### 3. Alignment Default

**Decision**: Auto-set alignment from archetype, allow override

**Rationale**: MidsReborn auto-sets based on `archetype.classType` (Hero vs Villain ATs), but user can change via toggle.

### 4. Archetype Change Confirmation

**Decision**: Show confirmation dialog if powersets selected

**Rationale**: MidsReborn behavior - changing AT resets incompatible powersets. Warn user before destructive action.

### 5. Component Location

**Decision**: Place in `SidePanel` (not TopPanel)

**Rationale**: MidsReborn has character creation in top-left panel, but web UX benefits from collapsible sidebar. TopPanel reserved for build info display.

### 6. Search in Archetype Selector

**Decision**: Use shadcn/ui Command component for search

**Rationale**: 15+ archetypes benefit from search/filter. Improves UX over simple dropdown.

---

## Estimated Time

**Total**: 8-12 hours

- Task 1 (CharacterStore): 1-2 hours
- Task 2 (useArchetypes): 1 hour
- Task 3 (CharacterNameInput): 1 hour
- Task 4 (ArchetypeSelector): 2-3 hours (most complex)
- Task 5 (OriginSelector): 1 hour
- Task 6 (AlignmentSelector): 1 hour
- Task 7 (ArchetypeInfoDisplay): 1-2 hours
- Task 8 (CharacterCreationPanel): 1 hour
- Task 9 (Integration): 0.5 hour
- Task 10 (Testing & QA): 1-2 hours

---

**Status**: ✅ Planning Complete - Ready for Execution
**Components**: 6 (CharacterNameInput, ArchetypeSelector, OriginSelector, AlignmentSelector, ArchetypeInfoDisplay, CharacterCreationPanel)
**Tests**: ~25 tests across all components
**Dependencies**: Epic 1.2 ✅, Epic 1.3 ✅, Backend API ✅
**Next**: Execute via superpowers or direct implementation
