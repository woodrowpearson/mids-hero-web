# Epic 3.4, 4.x, 5, 6 - Implementation Plans

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement these plans task-by-task.

This document contains condensed implementation plans for the remaining epics.

---

# Epic 3.4: API Testing & Documentation

**Goal:** Comprehensive API testing and OpenAPI documentation.

**Duration**: 2 days

## Task 3.4.1: Integration Test Suite

**Files:**
- Create: `tests/integration/test_api_workflows.py`
- Create: `tests/performance/test_api_performance.py`

### Complete Build Creation Workflow Test

```python
@pytest.mark.integration
async def test_complete_build_workflow(client, db_session):
    """Test full build creation, modification, calculation flow"""
    # Step 1: Create build
    build_response = client.post("/api/builds", json={
        "name": "Integration Test Build",
        "archetype_id": 1,
        "level": 50
    })
    assert build_response.status_code == 201
    build_id = build_response.json()['id']

    # Step 2: Add powers
    for i in range(5):
        power_response = client.post(f"/api/builds/{build_id}/powers", json={
            "power_id": i+1,
            "level_taken": (i*2)+1,
            "slot_number": i+1
        })
        assert power_response.status_code == 201

    # Step 3: Add enhancements to powers
    slot_id = power_response.json()['id']
    enh_response = client.put(f"/api/builds/{build_id}/powers/{slot_id}", json={
        "enhancements": [
            {"enhancement_id": 1, "level": 50},
            {"enhancement_id": 2, "level": 50}
        ]
    })
    assert enh_response.status_code == 200

    # Step 4: Calculate build stats
    calc_response = client.post(f"/api/builds/{build_id}/calculate")
    assert calc_response.status_code == 200
    stats = calc_response.json()
    assert 'health' in stats
    assert 'damage_totals' in stats

    # Step 5: Retrieve full build
    get_response = client.get(f"/api/builds/{build_id}")
    assert get_response.status_code == 200
    full_build = get_response.json()
    assert len(full_build['powers']) == 5

    # Step 6: Delete build
    delete_response = client.delete(f"/api/builds/{build_id}")
    assert delete_response.status_code == 204
```

**Commit:**
```bash
git add tests/integration/test_api_workflows.py
git commit -m "test: add complete API workflow integration test"
```

## Task 3.4.2: Performance Testing

```python
@pytest.mark.performance
def test_api_response_times(client):
    """Test that API endpoints meet performance targets"""
    import time

    # GET endpoints should be <200ms
    start = time.time()
    response = client.get("/api/archetypes")
    duration = (time.time() - start) * 1000
    assert duration < 200, f"GET /api/archetypes took {duration}ms"

    # POST endpoints should be <100ms
    start = time.time()
    response = client.post("/api/builds", json={"name": "Perf Test", "archetype_id": 1})
    duration = (time.time() - start) * 1000
    assert duration < 100, f"POST /api/builds took {duration}ms"

    # Calculation endpoints should be <500ms
    build_id = response.json()['id']
    start = time.time()
    response = client.post(f"/api/builds/{build_id}/calculate")
    duration = (time.time() - start) * 1000
    assert duration < 500, f"POST /api/builds/{id}/calculate took {duration}ms"
```

## Task 3.4.3: OpenAPI Documentation

**Files:**
- Modify: `backend/app/main.py`
- Create: `docs/API.md`

```python
# Add comprehensive OpenAPI metadata
app = FastAPI(
    title="Mids Hero Web API",
    description="""
    Modern City of Heroes character build planner API.

    ## Features
    - Character archetypes and powersets
    - Enhancement sets and bonuses
    - Build creation and management
    - Real-time damage/defense calculations
    - Power analysis (DPS, DPA, DPE)

    ## Authentication
    (To be implemented in future epic)
    """,
    version="0.3.0",
    docs_url="/api/docs",
    redoc_url="/api/redoc"
)

# Add detailed endpoint examples
@router.post("/api/builds", response_model=BuildResponse,
    summary="Create a new character build",
    responses={
        201: {"description": "Build created successfully"},
        400: {"description": "Invalid build data"},
        422: {"description": "Validation error"}
    })
async def create_build(build: BuildCreate, db: Session = Depends(get_db)):
    """
    Create a new character build with:
    - **name**: Build name (required)
    - **archetype_id**: Character archetype (required)
    - **level**: Character level 1-50 (default: 1)
    - **description**: Optional description
    """
    # ... implementation
```

**Commit:**
```bash
git add backend/app/main.py docs/API.md
git commit -m "docs: add comprehensive OpenAPI documentation"
```

---

# Epic 4: Frontend Application

**Goal:** React frontend for build planning.

**Duration**: 20 days

## Epic 4.1: Core UI Components (5 days)

### Task 4.1.1: Setup React Project

```bash
cd frontend
npm create vite@latest . -- --template react-ts
npm install @tanstack/react-query axios tailwindcss shadcn-ui
npx shadcn-ui@latest init
```

### Task 4.1.2: Component Library Structure

**Files:**
- Create: `frontend/src/components/layouts/AppLayout.tsx`
- Create: `frontend/src/components/archetypes/ArchetypeCard.tsx`
- Create: `frontend/src/components/powers/PowerSlot.tsx`

```typescript
// AppLayout.tsx
import { Outlet } from 'react-router-dom';
import { Sidebar } from './Sidebar';
import { Header } from './Header';

export const AppLayout: React.FC = () => {
  return (
    <div className="flex h-screen bg-gray-900 text-gray-100">
      <Sidebar />
      <div className="flex-1 flex flex-col">
        <Header />
        <main className="flex-1 overflow-auto p-6">
          <Outlet />
        </main>
      </div>
    </div>
  );
};
```

```typescript
// ArchetypeCard.tsx
import { Card, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';

interface ArchetypeCardProps {
  archetype: {
    id: number;
    name: string;
    description: string;
    icon: string;
  };
  onSelect: (id: number) => void;
}

export const ArchetypeCard: React.FC<ArchetypeCardProps> = ({ archetype, onSelect }) => {
  return (
    <Card
      className="cursor-pointer hover:border-blue-500 transition-colors"
      onClick={() => onSelect(archetype.id)}
    >
      <CardHeader>
        <img src={archetype.icon} alt={archetype.name} className="w-16 h-16 mb-2" />
        <CardTitle>{archetype.name}</CardTitle>
        <CardDescription>{archetype.description}</CardDescription>
      </CardHeader>
    </Card>
  );
};
```

```typescript
// PowerSlot.tsx
import { Power } from '@/types/power';

interface PowerSlotProps {
  power?: Power;
  slotNumber: number;
  level: number;
  onClick: () => void;
}

export const PowerSlot: React.FC<PowerSlotProps> = ({ power, slotNumber, level, onClick }) => {
  return (
    <div
      className="border border-gray-700 rounded p-3 cursor-pointer hover:border-blue-500"
      onClick={onClick}
    >
      {power ? (
        <div>
          <div className="font-semibold">{power.name}</div>
          <div className="text-xs text-gray-400">Level {level}</div>
          <div className="mt-2 flex gap-1">
            {/* Enhancement slots */}
            {Array.from({ length: 6 }).map((_, i) => (
              <div key={i} className="w-6 h-6 border border-gray-600 rounded-sm" />
            ))}
          </div>
        </div>
      ) : (
        <div className="text-center text-gray-500">
          Slot {slotNumber}
        </div>
      )}
    </div>
  );
};
```

**Commit:**
```bash
git add frontend/src/components/
git commit -m "feat: add core UI component library"
```

## Epic 4.2: Build Editor (8 days)

### Task 4.2.1: Build Editor Page

**Files:**
- Create: `frontend/src/pages/BuildEditor.tsx`
- Create: `frontend/src/hooks/useBuild.ts`
- Create: `frontend/src/api/builds.ts`

```typescript
// useBuild.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { buildsApi } from '@/api/builds';

export const useBuild = (buildId?: number) => {
  const queryClient = useQueryClient();

  const { data: build, isLoading } = useQuery({
    queryKey: ['build', buildId],
    queryFn: () => buildsApi.getBuild(buildId!),
    enabled: !!buildId
  });

  const createBuild = useMutation({
    mutationFn: buildsApi.createBuild,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['builds'] });
    }
  });

  const updateBuild = useMutation({
    mutationFn: ({ id, data }: { id: number, data: any }) =>
      buildsApi.updateBuild(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['build', buildId] });
    }
  });

  const calculateStats = useMutation({
    mutationFn: (id: number) => buildsApi.calculateStats(id),
  });

  return {
    build,
    isLoading,
    createBuild,
    updateBuild,
    calculateStats
  };
};
```

```typescript
// BuildEditor.tsx
export const BuildEditor: React.FC = () => {
  const { buildId } = useParams();
  const { build, calculateStats } = useBuild(Number(buildId));
  const [selectedPower, setSelectedPower] = useState<Power | null>(null);
  const [stats, setStats] = useState<BuildStats | null>(null);

  useEffect(() => {
    if (build?.id) {
      calculateStats.mutate(build.id, {
        onSuccess: (data) => setStats(data)
      });
    }
  }, [build?.powers]); // Recalculate when powers change

  return (
    <div className="grid grid-cols-12 gap-4">
      {/* Left: Power Grid */}
      <div className="col-span-8">
        <BuildHeader build={build} />
        <PowerGrid
          powers={build?.powers || []}
          onPowerClick={setSelectedPower}
        />
      </div>

      {/* Right: Details & Stats */}
      <div className="col-span-4 space-y-4">
        {selectedPower && (
          <PowerDetailsPanel power={selectedPower} />
        )}
        <BuildStatsPanel stats={stats} />
      </div>
    </div>
  );
};
```

**Commit:**
```bash
git add frontend/src/pages/BuildEditor.tsx frontend/src/hooks/ frontend/src/api/
git commit -m "feat: implement build editor page with real-time calculation"
```

## Epic 4.3: Data Display Pages (4 days)

### Task 4.3.1: Archetype Browser

```typescript
// pages/ArchetypeBrowser.tsx
export const ArchetypeBrowser: React.FC = () => {
  const { data: archetypes } = useQuery({
    queryKey: ['archetypes'],
    queryFn: archetypesApi.getAll
  });

  const [search, setSearch] = useState('');
  const [filter, setFilter] = useState<string | null>(null);

  const filtered = archetypes?.filter(at =>
    at.name.toLowerCase().includes(search.toLowerCase()) &&
    (!filter || at.primary_category === filter)
  );

  return (
    <div>
      <SearchBar value={search} onChange={setSearch} />
      <FilterBar value={filter} onChange={setFilter} />
      <div className="grid grid-cols-3 gap-4">
        {filtered?.map(archetype => (
          <ArchetypeCard
            key={archetype.id}
            archetype={archetype}
            onSelect={handleSelect}
          />
        ))}
      </div>
    </div>
  );
};
```

---

# Epic 5: Deployment (8 days)

**Goal:** Production deployment infrastructure.

## Task 5.1: Docker Production Configuration

**Files:**
- Create: `docker-compose.prod.yml`
- Create: `frontend/Dockerfile.prod`
- Modify: `backend/Dockerfile`

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - frontend
      - backend

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    environment:
      - VITE_API_URL=https://api.midshero.com

  backend:
    build: ./backend
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - ENV=production
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '1'
          memory: 1G

  database:
    image: postgres:15
    environment:
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redisdata:/data

volumes:
  pgdata:
  redisdata:
```

```dockerfile
# frontend/Dockerfile.prod
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
```

## Task 5.2: CI/CD Pipeline

**Files:**
- Create: `.github/workflows/deploy-production.yml`

```yaml
name: Deploy Production

on:
  push:
    branches: [main]
    tags: ['v*']

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run backend tests
        run: |
          cd backend
          just test
      - name: Run frontend tests
        run: |
          cd frontend
          npm test

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Docker images
        run: docker-compose -f docker-compose.prod.yml build

      - name: Push to registry
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          docker-compose -f docker-compose.prod.yml push

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/mids-hero-web
            docker-compose -f docker-compose.prod.yml pull
            docker-compose -f docker-compose.prod.yml up -d
```

## Task 5.3: Monitoring Setup

**Files:**
- Create: `monitoring/prometheus.yml`
- Create: `monitoring/grafana-dashboard.json`

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'backend'
    static_configs:
      - targets: ['backend:8000']

  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
```

---

# Epic 6: Optimization (8 days)

**Goal:** Performance optimization and advanced features.

## Task 6.1: Backend Caching

**Files:**
- Create: `backend/app/cache/redis_cache.py`
- Modify: `backend/app/api/routers/archetypes.py`

```python
# redis_cache.py
import json
import redis
from functools import wraps
from typing import Any, Callable

redis_client = redis.Redis(host='redis', port=6379, decode_responses=True)

def cached(ttl: int = 3600):
    """Cache decorator for expensive operations"""
    def decorator(func: Callable) -> Callable:
        @wraps(func)
        async def wrapper(*args, **kwargs) -> Any:
            # Generate cache key
            cache_key = f"{func.__name__}:{str(args)}:{str(kwargs)}"

            # Check cache
            cached_value = redis_client.get(cache_key)
            if cached_value:
                return json.loads(cached_value)

            # Call function
            result = await func(*args, **kwargs)

            # Store in cache
            redis_client.setex(cache_key, ttl, json.dumps(result))

            return result
        return wrapper
    return decorator

# Usage:
@router.get("/api/archetypes")
@cached(ttl=3600)
async def get_archetypes(db: Session = Depends(get_db)):
    return db.query(Archetype).all()
```

## Task 6.2: Database Optimization

```sql
-- Add strategic indexes
CREATE INDEX CONCURRENTLY idx_powers_archetype ON powers(archetype_id);
CREATE INDEX CONCURRENTLY idx_powers_powerset ON powers(powerset_id);
CREATE INDEX CONCURRENTLY idx_powers_tags ON powers USING GIN(tags);
CREATE INDEX CONCURRENTLY idx_enhancements_set ON enhancements(set_id);
CREATE INDEX CONCURRENTLY idx_build_powers_build ON power_slots(build_id);

-- Create materialized view for expensive calculations
CREATE MATERIALIZED VIEW power_stats_cache AS
SELECT
    p.id,
    p.name,
    p.source_metadata->'activation'->>'time' AS cast_time,
    p.source_metadata->'activation'->>'recharge_time' AS recharge_time,
    -- Calculate DPS, DPA from JSON metadata
    (jsonb_array_length(p.source_metadata->'effects')) AS effect_count
FROM powers p;

CREATE INDEX ON power_stats_cache(id);

-- Refresh daily
CREATE OR REPLACE FUNCTION refresh_power_stats()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY power_stats_cache;
END;
$$ LANGUAGE plpgsql;
```

## Task 6.3: Frontend Performance

```typescript
// Code splitting
const BuildEditor = lazy(() => import('./pages/BuildEditor'));
const ArchetypeBrowser = lazy(() => import('./pages/ArchetypeBrowser'));

// Optimized rendering with React.memo
export const PowerSlot = React.memo<PowerSlotProps>(({ power, onClick }) => {
  return (
    <div onClick={onClick}>
      {/* ... */}
    </div>
  );
}, (prev, next) => prev.power?.id === next.power?.id);

// Virtual scrolling for large lists
import { FixedSizeList } from 'react-window';

export const PowerList: React.FC = ({ powers }) => {
  return (
    <FixedSizeList
      height={600}
      itemCount={powers.length}
      itemSize={80}
      width="100%"
    >
      {({ index, style }) => (
        <div style={style}>
          <PowerCard power={powers[index]} />
        </div>
      )}
    </FixedSizeList>
  );
};
```

---

# Summary

All Epic plans have been created in `docs/plans/` with:

- **Epic 2.5.5**: Cleanup & JSON prep (8 days)
- **Epic 2.6**: JSON migration (8 days)
- **Epic 3.2**: Calculation endpoints (4 days)
- **Epic 3.3**: Write operations (2 days)
- **Epic 3.4**: API testing (2 days)
- **Epic 4.1-4.3**: Frontend (20 days)
- **Epic 5**: Deployment (8 days)
- **Epic 6**: Optimization (8 days)

**Total**: ~60 days of development work

Each plan follows TDD methodology with exact file paths, complete code examples, and step-by-step implementation instructions.
