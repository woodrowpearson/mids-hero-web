# Epic 2.2: Powerset Selection - Detailed Implementation Plan

**Date**: 2025-11-18
**Epic**: 2.2 - Powerset Selection
**Summary**: PLAN-SUMMARY-epic-2.2.md
**MidsReborn Analysis**: docs/frontend/analysis/MIDSREBORN-UI-ANALYSIS-epic-2.2.md

---

## Background & Context

### Epic Objectives

From `docs/frontend/epic-breakdown.md`:

> **Epic 2.2: Powerset Selection**
>
> **Objectives**:
> - Create primary powerset selector (filtered by archetype)
> - Create secondary powerset selector (filtered by archetype)
> - Create pool power selectors (4 slots)
> - Create ancillary/epic selector
> - Implement powerset prerequisites and locking

### Context from Previous Epics

**Epic 2.1** (Archetype & Origin Selection) completed:
- Created `CharacterNameInput`, `ArchetypeSelector`, `OriginSelector`, `AlignmentSelector`
- Archetype selection working and stored in `characterStore`
- Origin filtered by archetype compatibility
- `CharacterCreationPanel` container component created

**Epic 2.2** builds on this foundation:
- Uses selected archetype to filter available powersets
- Adds powerset state to `characterStore`
- Integrates with `CharacterCreationPanel` from Epic 2.1

### MidsReborn Analysis

From `docs/frontend/analysis/MIDSREBORN-UI-ANALYSIS-epic-2.2.md`:

**MidsReborn Implementation**:
- 6 ComboBox controls in `frmMain.cs`: `cbPrimary`, `cbSecondary`, `cbPool0-3`, `cbAncillary`
- Primary/Secondary filtered by archetype using `DatabaseAPI.GetPowersetIndexes()`
- Pool powers universal (all ATs), must prevent duplicate selection across 4 slots
- Ancillary disabled until level 35+, hidden for Epic ATs

**Key Behaviors Identified**:
1. Archetype change resets all powersets (requires confirmation if powers selected)
2. Powerset change clears selected powers from that set (confirmation required)
3. Pool validation: Can't select same pool twice
4. Linked secondaries: Some ATs have secondary auto-selected based on primary
5. Epic ATs: Hide pool/ancillary selectors

---

## Component Specifications

### 1. PowersetSelector (Base Component)

**File**: `frontend/src/components/character/PowersetSelector.tsx`

**Purpose**: Reusable base component for all powerset dropdowns

**Props Interface**:
```typescript
interface PowersetSelectorProps {
  type: 'Primary' | 'Secondary' | 'Pool' | 'Ancillary';
  powersets: Powerset[];
  selected: Powerset | null;
  onChange: (powerset: Powerset | null) => void;
  disabled?: boolean;
  placeholder?: string;
  showIcons?: boolean;
  showSearch?: boolean;
  allowClear?: boolean;
}
```

**State**:
- Local state for search filter (if `showSearch === true`)

**UI Structure**:
```tsx
<Select
  value={selected?.id}
  onValueChange={(value) => {
    const powerset = powersets.find(p => p.id === value);
    onChange(powerset || null);
  }}
  disabled={disabled}
>
  <SelectTrigger>
    <SelectValue placeholder={placeholder} />
  </SelectTrigger>
  <SelectContent>
    {showSearch && (
      <Command>
        <CommandInput placeholder="Search..." />
        <CommandList>
          {powersets.map(powerset => (
            <CommandItem key={powerset.id} value={powerset.id}>
              {showIcons && powerset.icon && (
                <Image src={powerset.icon} width={24} height={24} />
              )}
              <span>{powerset.displayName}</span>
            </CommandItem>
          ))}
        </CommandList>
      </Command>
    )}
    {!showSearch && powersets.map(powerset => (
      <SelectItem key={powerset.id} value={powerset.id}>
        {showIcons && powerset.icon && (
          <Image src={powerset.icon} width={24} height={24} />
        )}
        <span>{powerset.displayName}</span>
      </SelectItem>
    ))}
  </SelectContent>
</Select>
```

**Tests** (5 tests):
1. Renders with powersets from props
2. Filters powersets on search (if `showSearch === true`)
3. Calls onChange when powerset selected
4. Displays powerset icons (if `showIcons === true`)
5. Shows disabled state

---

### 2. PrimaryPowersetSelector

**File**: `frontend/src/components/character/PrimaryPowersetSelector.tsx`

**Purpose**: Primary powerset dropdown, filtered by archetype

**Props Interface**:
```typescript
interface PrimaryPowersetSelectorProps {
  // No props needed - reads from characterStore and usePowersets hook
}
```

**State**:
- `archetype` from `characterStore`
- `primaryPowerset` from `characterStore`
- `setPrimaryPowerset` action from `characterStore`
- `{ data: powersets, isLoading, error }` from `usePowersets(archetypeId)`

**Logic**:
```typescript
const archetype = useCharacterStore(state => state.archetype);
const primaryPowerset = useCharacterStore(state => state.primaryPowerset);
const setPrimaryPowerset = useCharacterStore(state => state.actions.setPrimaryPowerset);
const powers = useCharacterStore(state => state.powers); // For confirmation check

const { data: powersets, isLoading, error } = usePowersets(archetype?.id);

const primaryPowersets = powersets?.filter(p => p.type === 'Primary') || [];

const handleChange = (powerset: Powerset | null) => {
  // Check if powers already selected
  const hasPowersFromPrimary = powers.some(p => p.powerset === primaryPowerset?.id);

  if (hasPowersFromPrimary && powerset) {
    // Show confirmation dialog
    showConfirmation({
      title: 'Change Primary Powerset?',
      message: `Changing your primary powerset will clear all powers from ${primaryPowerset.displayName}. Continue?`,
      onConfirm: () => setPrimaryPowerset(powerset),
    });
  } else {
    setPrimaryPowerset(powerset);
  }
};
```

**UI Structure**:
```tsx
<div className="flex flex-col gap-2">
  <Label htmlFor="primary-powerset">Primary Powerset</Label>
  {isLoading && <Skeleton className="h-10 w-full" />}
  {error && <ErrorMessage message="Failed to load powersets" />}
  {!isLoading && !error && (
    <PowersetSelector
      type="Primary"
      powersets={primaryPowersets}
      selected={primaryPowerset}
      onChange={handleChange}
      disabled={!archetype}
      placeholder="Select Primary Powerset"
      showIcons
      showSearch
    />
  )}
  {primaryPowerset && (
    <p className="text-sm text-muted-foreground">{primaryPowerset.description}</p>
  )}
</div>
```

**Tests** (6 tests):
1. Renders disabled when no archetype selected
2. Shows archetype's primary powersets
3. Updates store on selection
4. Shows confirmation when changing mid-build (with powers)
5. Handles loading state
6. Handles error state

---

### 3. SecondaryPowersetSelector

**File**: `frontend/src/components/character/SecondaryPowersetSelector.tsx`

**Purpose**: Secondary powerset dropdown, filtered by archetype, handles linked secondaries

**Props Interface**:
```typescript
interface SecondaryPowersetSelectorProps {
  // No props needed - reads from characterStore and usePowersets hook
}
```

**State**:
- `archetype` from `characterStore`
- `secondaryPowerset` from `characterStore`
- `setSecondaryPowerset` action from `characterStore`
- `{ data: powersets }` from `usePowersets(archetypeId)`

**Logic**:
```typescript
const archetype = useCharacterStore(state => state.archetype);
const primaryPowerset = useCharacterStore(state => state.primaryPowerset);
const secondaryPowerset = useCharacterStore(state => state.secondaryPowerset);
const setSecondaryPowerset = useCharacterStore(state => state.actions.setSecondaryPowerset);

const { data: powersets } = usePowersets(archetype?.id);

const secondaryPowersets = powersets?.filter(p => p.type === 'Secondary') || [];

// Check for linked secondary (e.g., Kheldians)
const linkedSecondary = primaryPowerset?.linkedSecondaryId
  ? secondaryPowersets.find(p => p.id === primaryPowerset.linkedSecondaryId)
  : null;

useEffect(() => {
  if (linkedSecondary && secondaryPowerset?.id !== linkedSecondary.id) {
    setSecondaryPowerset(linkedSecondary);
  }
}, [linkedSecondary, secondaryPowerset, setSecondaryPowerset]);

const isLinked = !!linkedSecondary;
```

**UI Structure**:
```tsx
<div className="flex flex-col gap-2">
  <Label htmlFor="secondary-powerset">Secondary Powerset</Label>
  <PowersetSelector
    type="Secondary"
    powersets={secondaryPowersets}
    selected={secondaryPowerset}
    onChange={setSecondaryPowerset}
    disabled={!archetype || isLinked}
    placeholder="Select Secondary Powerset"
    showIcons
    showSearch
  />
  {isLinked && (
    <p className="text-sm text-muted-foreground">
      Secondary linked to primary (auto-selected)
    </p>
  )}
</div>
```

**Tests** (6 tests):
1. Renders disabled when no archetype
2. Shows archetype's secondary powersets
3. Updates store on selection
4. Handles linked secondaries (auto-select, disable dropdown)
5. Shows confirmation when changing mid-build
6. Resets when archetype changes

---

### 4. PoolPowerSelector

**File**: `frontend/src/components/character/PoolPowerSelector.tsx`

**Purpose**: Pool power dropdown (used 4 times), prevents duplicate selection

**Props Interface**:
```typescript
interface PoolPowerSelectorProps {
  index: number; // 0-3 for the 4 pool slots
}
```

**State**:
- `poolPowersets` from `characterStore` (array of 4)
- `setPoolPowerset(index, powerset)` action from `characterStore`
- `{ data: allPowersets }` from `usePowersets()` (fetch all pool powers)

**Logic**:
```typescript
const poolPowersets = useCharacterStore(state => state.poolPowersets);
const setPoolPowerset = useCharacterStore(state => state.actions.setPoolPowerset);

const { data: allPowersets } = useQuery({
  queryKey: ['powersets', 'pool'],
  queryFn: () => api.get('/api/powersets?type=Pool'),
  staleTime: Infinity,
});

const poolPowers = allPowersets?.filter(p => p.type === 'Pool') || [];

// Filter out already-selected pools from other slots
const availablePools = poolPowers.filter(pool => {
  const selectedInOtherSlot = poolPowersets.some((p, idx) =>
    idx !== index && p?.id === pool.id
  );
  return !selectedInOtherSlot;
});

const handleChange = (powerset: Powerset | null) => {
  setPoolPowerset(index, powerset);
};
```

**UI Structure**:
```tsx
<div className="flex flex-col gap-2">
  <Label htmlFor={`pool-${index}`}>Pool Power {index + 1}</Label>
  <PowersetSelector
    type="Pool"
    powersets={availablePools}
    selected={poolPowersets[index]}
    onChange={handleChange}
    placeholder={`Select Pool Power ${index + 1}`}
    showIcons
    showSearch
    allowClear
  />
  {poolPowersets[index] && (
    <p className="text-sm text-muted-foreground">
      {poolPowersets[index].description}
    </p>
  )}
</div>
```

**Tests** (7 tests):
1. Renders all pool powersets
2. Filters out already-selected pools from other slots
3. Updates store at correct index
4. Can be cleared (set to null)
5. Shows mutual exclusivity warnings (if applicable)
6. Multiple instances don't interfere with each other
7. Validation prevents duplicate pools

---

### 5. AncillarySelector

**File**: `frontend/src/components/character/AncillarySelector.tsx`

**Purpose**: Ancillary/Epic powerset dropdown, level-gated (35+), hidden for Epic ATs

**Props Interface**:
```typescript
interface AncillarySelectorProps {
  // No props needed - reads from characterStore
}
```

**State**:
- `archetype` from `characterStore`
- `ancillaryPowerset` from `characterStore`
- `setAncillaryPowerset` action from `characterStore`
- `level` from `characterStore`
- `{ data: powersets }` from `usePowersets(archetypeId)`

**Logic**:
```typescript
const archetype = useCharacterStore(state => state.archetype);
const ancillaryPowerset = useCharacterStore(state => state.ancillaryPowerset);
const setAncillaryPowerset = useCharacterStore(state => state.actions.setAncillaryPowerset);
const level = useCharacterStore(state => state.level);

const { data: powersets } = usePowersets(archetype?.id);

const ancillaryPowersets = powersets?.filter(p =>
  p.type === 'Ancillary' || p.type === 'Epic'
) || [];

const isEpicAT = archetype?.isEpic || false;
const isEnabled = level >= 35 && !isEpicAT;

// Hide if Epic AT
if (isEpicAT) return null;
```

**UI Structure**:
```tsx
<div className="flex flex-col gap-2">
  <Label htmlFor="ancillary-powerset">
    Ancillary/Epic Powerset
    {level < 35 && <span className="text-muted-foreground"> (Unlocks at 35)</span>}
  </Label>
  <PowersetSelector
    type="Ancillary"
    powersets={ancillaryPowersets}
    selected={ancillaryPowerset}
    onChange={setAncillaryPowerset}
    disabled={!isEnabled}
    placeholder="Select Ancillary Powerset"
    showIcons
    showSearch
  />
  {ancillaryPowerset && (
    <p className="text-sm text-muted-foreground">
      {ancillaryPowerset.description}
    </p>
  )}
</div>
```

**Tests** (5 tests):
1. Renders disabled when level < 35
2. Enables when level >= 35
3. Hidden for Epic ATs
4. Shows archetype's ancillary powersets
5. Updates store on selection

---

### 6. PowersetSelectionPanel

**File**: `frontend/src/components/character/PowersetSelectionPanel.tsx`

**Purpose**: Container component composing all powerset selectors

**Props Interface**:
```typescript
interface PowersetSelectionPanelProps {
  // No props needed - all state from characterStore
}
```

**State**:
- Delegates to child components
- Monitors archetype changes to reset powersets

**Logic**:
```typescript
const archetype = useCharacterStore(state => state.archetype);
const resetPowersets = useCharacterStore(state => state.actions.resetPowersets);

// Watch for archetype changes
const prevArchetypeRef = useRef(archetype);

useEffect(() => {
  const prevArchetype = prevArchetypeRef.current;

  if (prevArchetype && archetype && prevArchetype.id !== archetype.id) {
    // Archetype changed - reset powersets
    resetPowersets();
  }

  prevArchetypeRef.current = archetype;
}, [archetype, resetPowersets]);
```

**UI Structure**:
```tsx
<div className="flex flex-col gap-6 p-4">
  <h2 className="text-xl font-semibold">Powersets</h2>

  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
    <PrimaryPowersetSelector />
    <SecondaryPowersetSelector />
  </div>

  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div className="flex flex-col gap-4">
      <h3 className="text-lg font-medium">Pool Powers</h3>
      <PoolPowerSelector index={0} />
      <PoolPowerSelector index={1} />
      <PoolPowerSelector index={2} />
      <PoolPowerSelector index={3} />
    </div>

    <AncillarySelector />
  </div>
</div>
```

**Tests** (3 tests):
1. Renders all child components
2. Coordinates state updates
3. Resets powersets when archetype changes

---

## State Management Plan

### CharacterStore Updates

**File**: `frontend/src/stores/characterStore.ts`

**New State Fields**:
```typescript
interface CharacterState {
  // ... existing fields from Epic 2.1
  archetype: Archetype | null;
  origin: string | null;
  alignment: Alignment | null;

  // New for Epic 2.2
  primaryPowerset: Powerset | null;
  secondaryPowerset: Powerset | null;
  poolPowersets: (Powerset | null)[]; // Array of 4
  ancillaryPowerset: Powerset | null;
  level: number; // Default: 1
  powers: PowerEntry[]; // For next epic, but add now for confirmation checks
}
```

**New Actions**:
```typescript
interface CharacterActions {
  // ... existing actions

  // New for Epic 2.2
  setPrimaryPowerset: (powerset: Powerset | null) => void;
  setSecondaryPowerset: (powerset: Powerset | null) => void;
  setPoolPowerset: (index: number, powerset: Powerset | null) => void;
  setAncillaryPowerset: (powerset: Powerset | null) => void;
  setLevel: (level: number) => void;
  resetPowersets: () => void; // Helper to reset all powersets
}
```

**Implementation**:
```typescript
export const useCharacterStore = create<CharacterState>()(
  devtools(
    persist(
      (set, get) => ({
        // ... existing state

        // New state
        primaryPowerset: null,
        secondaryPowerset: null,
        poolPowersets: [null, null, null, null],
        ancillaryPowerset: null,
        level: 1,
        powers: [],

        actions: {
          // ... existing actions

          setPrimaryPowerset: (powerset) => {
            set({ primaryPowerset: powerset });
            // TODO: Clear powers from old primary (next epic)
          },

          setSecondaryPowerset: (powerset) => {
            set({ secondaryPowerset: powerset });
            // TODO: Clear powers from old secondary (next epic)
          },

          setPoolPowerset: (index, powerset) => {
            const poolPowersets = [...get().poolPowersets];
            poolPowersets[index] = powerset;
            set({ poolPowersets });
            // TODO: Clear powers from old pool (next epic)
          },

          setAncillaryPowerset: (powerset) => {
            set({ ancillaryPowerset: powerset });
            // TODO: Clear powers from old ancillary (next epic)
          },

          setLevel: (level) => set({ level }),

          resetPowersets: () => {
            set({
              primaryPowerset: null,
              secondaryPowerset: null,
              poolPowersets: [null, null, null, null],
              ancillaryPowerset: null,
            });
          },

          // Enhanced from Epic 2.1
          setArchetype: (archetype) => {
            set({ archetype });
            get().actions.resetPowersets(); // Reset powersets when AT changes
            // TODO: Show confirmation if powers selected
          },
        },
      }),
      {
        name: 'character-build-storage',
        partialize: (state) => ({
          // ... existing fields
          primaryPowerset: state.primaryPowerset,
          secondaryPowerset: state.secondaryPowerset,
          poolPowersets: state.poolPowersets,
          ancillaryPowerset: state.ancillaryPowerset,
          level: state.level,
        }),
      }
    )
  )
);
```

---

## API Integration Plan

### usePowersets Hook

**File**: `frontend/src/hooks/usePowersets.ts`

**Purpose**: Fetch powersets for a given archetype using TanStack Query

**Implementation**:
```typescript
import { useQuery } from '@tanstack/react-query';
import api from '@/services/api';
import type { Powerset } from '@/types/powerset.types';

interface UsePowersetsOptions {
  archetypeId?: string;
  type?: 'Primary' | 'Secondary' | 'Pool' | 'Ancillary' | 'Epic';
}

export function usePowersets(archetypeId?: string, options?: UsePowersetsOptions) {
  return useQuery({
    queryKey: ['powersets', archetypeId, options?.type],
    queryFn: async () => {
      if (archetypeId) {
        // Fetch powersets for specific archetype
        const params = options?.type ? `?type=${options.type}` : '';
        const response = await api.get<Powerset[]>(
          `/api/archetypes/${archetypeId}/powersets${params}`
        );
        return response.data;
      } else {
        // Fetch all powersets (for pool powers)
        const response = await api.get<Powerset[]>('/api/powersets');
        return response.data;
      }
    },
    enabled: !!archetypeId || options?.type === 'Pool',
    staleTime: Infinity, // Static game data - cache forever
    gcTime: Infinity, // Keep in cache indefinitely
  });
}
```

**Usage Examples**:
```typescript
// Fetch all powersets for selected archetype
const { data: powersets } = usePowersets(archetypeId);

// Fetch only primary powersets
const { data: primaryPowersets } = usePowersets(archetypeId, { type: 'Primary' });

// Fetch all pool powers
const { data: poolPowers } = usePowersets(undefined, { type: 'Pool' });
```

**Tests** (4 tests):
1. Fetches powersets from API by archetype
2. Returns loading state while fetching
3. Returns data on success
4. Handles errors gracefully

---

## TypeScript Types

### Powerset Type Definition

**File**: `frontend/src/types/powerset.types.ts`

```typescript
export interface Powerset {
  id: string;
  name: string; // Internal name (e.g., "Blaster_Primary.Archery")
  displayName: string; // User-facing name (e.g., "Archery")
  description: string;
  icon?: string; // URL to icon image
  type: PowersetType;
  archetypeId?: string; // For primary/secondary/ancillary
  levelAvailable: number; // 1 for most, 35 for ancillary
  linkedSecondaryId?: string; // For Epic ATs with forced secondary
  mutuallyExclusive?: string[]; // IDs of pools that exclude this one
}

export type PowersetType = 'Primary' | 'Secondary' | 'Pool' | 'Ancillary' | 'Epic';

export interface PowersetWithPowers extends Powerset {
  powers: Power[]; // For next epic
}
```

---

## Implementation Tasks

### Task Breakdown (Step-by-Step)

#### Task 1: Update CharacterStore (1-2 hours)

1. Open `frontend/src/stores/characterStore.ts`
2. Add new state fields:
   - `primaryPowerset: null`
   - `secondaryPowerset: null`
   - `poolPowersets: [null, null, null, null]`
   - `ancillaryPowerset: null`
   - `level: 1`
3. Add new actions:
   - `setPrimaryPowerset`
   - `setSecondaryPowerset`
   - `setPoolPowerset`
   - `setAncillaryPowerset`
   - `setLevel`
   - `resetPowersets`
4. Update `setArchetype` to call `resetPowersets()`
5. Add new fields to `partialize` for persistence
6. Write tests for new actions

**Tests**:
- `setPrimaryPowerset` updates state correctly
- `setSecondaryPowerset` updates state correctly
- `setPoolPowerset` updates correct index
- `setAncillaryPowerset` updates state correctly
- `setLevel` updates state correctly
- `resetPowersets` clears all powersets
- `setArchetype` resets powersets

---

#### Task 2: Create TypeScript Types (30 minutes)

1. Create `frontend/src/types/powerset.types.ts`
2. Define `Powerset` interface
3. Define `PowersetType` type
4. Export types

**Tests**: None (types only)

---

#### Task 3: Create usePowersets Hook (1 hour)

1. Create `frontend/src/hooks/usePowersets.ts`
2. Implement TanStack Query hook
3. Support optional `archetypeId` parameter
4. Support optional `type` filter
5. Write tests

**Tests**:
- Fetches from API with correct endpoint
- Returns loading state
- Returns data on success
- Handles errors
- Caches data correctly

---

#### Task 4: Create PowersetSelector Base Component (2-3 hours)

1. Create `frontend/src/components/character/PowersetSelector.tsx`
2. Implement Select with optional search (Command)
3. Add icon support
4. Add disabled state
5. Add allowClear prop
6. Write tests

**Tests**:
- Renders with powersets
- Filters on search (if enabled)
- Calls onChange on selection
- Shows icons (if enabled)
- Shows disabled state

---

#### Task 5: Create PrimaryPowersetSelector (1-2 hours)

1. Create `frontend/src/components/character/PrimaryPowersetSelector.tsx`
2. Use `usePowersets(archetypeId)` to fetch powersets
3. Filter by `type === 'Primary'`
4. Connect to `characterStore`
5. Add confirmation dialog for mid-build changes
6. Write tests

**Tests**:
- Disabled when no archetype
- Shows primary powersets
- Updates store on selection
- Shows confirmation when needed
- Handles loading/error states

---

#### Task 6: Create SecondaryPowersetSelector (1-2 hours)

1. Create `frontend/src/components/character/SecondaryPowersetSelector.tsx`
2. Similar to primary, filter by `type === 'Secondary'`
3. Add linked secondary logic
4. Write tests

**Tests**:
- Disabled when no archetype
- Shows secondary powersets
- Handles linked secondaries
- Updates store on selection

---

#### Task 7: Create PoolPowerSelector (2-3 hours)

1. Create `frontend/src/components/character/PoolPowerSelector.tsx`
2. Accept `index` prop (0-3)
3. Fetch all pool powers
4. Filter out already-selected pools from other slots
5. Connect to `characterStore.poolPowersets[index]`
6. Write tests

**Tests**:
- Shows all pool powers
- Filters out selected pools
- Updates correct index
- Can be cleared
- Validation prevents duplicates

---

#### Task 8: Create AncillarySelector (1 hour)

1. Create `frontend/src/components/character/AncillarySelector.tsx`
2. Filter by `type === 'Ancillary' || type === 'Epic'`
3. Disable when `level < 35`
4. Hide when Epic AT
5. Write tests

**Tests**:
- Disabled when level < 35
- Enabled when level >= 35
- Hidden for Epic ATs
- Shows ancillary powersets

---

#### Task 9: Create PowersetSelectionPanel (1 hour)

1. Create `frontend/src/components/character/PowersetSelectionPanel.tsx`
2. Compose all 6 selectors:
   - Primary
   - Secondary
   - 4 × Pool
   - Ancillary
3. Layout with responsive grid
4. Watch for archetype changes → reset powersets
5. Write tests

**Tests**:
- Renders all children
- Coordinates state updates
- Resets on archetype change

---

#### Task 10: Integrate into CharacterCreationPanel (30 minutes)

1. Open `frontend/src/components/character/CharacterCreationPanel.tsx` (from Epic 2.1)
2. Import `PowersetSelectionPanel`
3. Add to layout below archetype/origin selectors
4. Test integration

**Tests**:
- PowersetSelectionPanel appears in CharacterCreationPanel
- All components render together

---

#### Task 11: Run All Tests & Quality Checks (1 hour)

1. Run `npm test` - ensure all ~30 tests passing
2. Run `npm run lint` - fix any ESLint errors
3. Run `npm run type-check` - fix any TypeScript errors
4. Manual testing:
   - Select archetype → see filtered powersets
   - Select powersets → persists to localStorage
   - Change archetype → powersets reset
   - Select 4 pools → duplicates prevented
   - Level < 35 → ancillary disabled
   - Level 35+ → ancillary enabled

---

## Acceptance Criteria

### Functional Requirements

- [ ] Primary powerset selector displays archetype's primary powersets
- [ ] Secondary powerset selector displays archetype's secondary powersets
- [ ] Pool power selectors (4 slots) display all pool powers
- [ ] Pool validation prevents selecting same pool twice
- [ ] Ancillary selector disabled when level < 35
- [ ] Ancillary selector hidden for Epic ATs
- [ ] Archetype change resets all powersets
- [ ] All selections update characterStore
- [ ] All selections persist across page refreshes (localStorage)
- [ ] Linked secondaries auto-selected and disabled

### Visual Requirements

- [ ] Components match MidsReborn functional layout
- [ ] Modern web aesthetic (shadcn/ui components)
- [ ] Icons display for powersets
- [ ] Searchable dropdowns for easy selection
- [ ] Responsive on mobile/tablet/desktop
- [ ] Loading states display during API fetch
- [ ] Error states display if API fails

### Technical Requirements

- [ ] All TypeScript strict mode compliant (no `any`)
- [ ] All tests passing (>80% coverage)
- [ ] ESLint and Prettier passing
- [ ] No console errors or warnings
- [ ] TanStack Query caching working correctly
- [ ] Zustand persistence working correctly

---

## Visual Verification Checklist

After implementation, compare with MidsReborn screenshots:

- [ ] **mids-new-build.png**: Primary/Secondary selectors match layout
- [ ] **pool-desc-mouse-over.png**: Pool selectors match (4 slots visible)
- [ ] Powerset icons display correctly
- [ ] Dropdowns searchable and responsive
- [ ] Disabled states match MidsReborn behavior
- [ ] Confirmation dialogs appear when needed

---

## Estimated Time

**Total**: 10-14 hours

**Breakdown**:
- Task 1 (CharacterStore): 1-2 hours
- Task 2 (Types): 30 minutes
- Task 3 (usePowersets): 1 hour
- Task 4 (PowersetSelector): 2-3 hours
- Task 5 (Primary): 1-2 hours
- Task 6 (Secondary): 1-2 hours
- Task 7 (Pool): 2-3 hours
- Task 8 (Ancillary): 1 hour
- Task 9 (Panel): 1 hour
- Task 10 (Integration): 30 minutes
- Task 11 (Testing): 1 hour

---

## Dependencies

### From Previous Epics

- ✅ Epic 1.2: CharacterStore, Zustand persistence
- ✅ Epic 1.3: BuildLayout, SidePanel
- ✅ Epic 1.4: API client, TanStack Query
- ✅ Epic 2.1: ArchetypeSelector, CharacterCreationPanel

### Backend API

- ✅ `GET /api/archetypes/{id}/powersets` - Already implemented
- ✅ `GET /api/powersets` - Already implemented
- ✅ `GET /api/powersets?type=Pool` - Check if query param supported

### shadcn/ui Components

**Already installed** (from Epic 1.1):
- Select
- Command (for search)
- Dialog (for confirmation)
- Label
- Skeleton (loading state)

**May need to install**:
- Popover or Tooltip (for powerset info)

---

## Next Steps After Epic 2.2

**Epic 3.1**: Available Powers Panel
- Display powers from selected powersets
- Power availability logic (level, prerequisites)
- Power picking interaction

**Prerequisites Met by Epic 2.2**:
- ✅ Powersets selected
- ✅ CharacterStore ready for `powers: PowerEntry[]`
- ✅ API endpoints ready (`GET /api/powersets/{id}/powers`)

---

**Document Status**: ✅ Complete - Ready for Implementation
**Created**: 2025-11-18
**Epic**: 2.2 - Powerset Selection
