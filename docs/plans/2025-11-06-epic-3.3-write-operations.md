# Epic 3.3: Build Write/Modify Operations

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement CRUD operations for character builds, power slots, and enhancements.

**Architecture:** RESTful API endpoints for creating, updating, and deleting builds with proper validation and database transactions.

**Tech Stack:** Python 3.11, FastAPI, SQLAlchemy, Pydantic, pytest

---

## Task 3.3.1: Implement Build CRUD Operations

### Subtask 3.3.1.1: POST /api/builds - Create Build

**Files:**
- Modify: `backend/app/api/routers/builds.py`
- Modify: `backend/app/schemas/build_schemas.py`
- Modify: `tests/backend/api/test_builds_api.py`

**Step 1: Write the failing test**

```python
def test_create_build(client, db_session):
    """Test creating a new build"""
    build_data = {
        "name": "My Tanker Build",
        "archetype_id": 1,
        "level": 50,
        "description": "Invulnerability/Super Strength"
    }

    response = client.post("/api/builds", json=build_data)

    assert response.status_code == 201
    data = response.json()
    assert data['name'] == "My Tanker Build"
    assert data['level'] == 50
    assert 'id' in data
```

**Step 2: Run test to verify it fails**

```bash
pytest tests/backend/api/test_builds_api.py::test_create_build -v
```

**Step 3: Implement endpoint**

```python
from backend.app.schemas.build_schemas import BuildCreate, BuildResponse

@router.post("", response_model=BuildResponse, status_code=201)
async def create_build(
    build: BuildCreate,
    db: Session = Depends(get_db)
):
    """Create a new character build"""
    new_build = Build(
        name=build.name,
        archetype_id=build.archetype_id,
        level=build.level,
        description=build.description
    )
    db.add(new_build)
    db.commit()
    db.refresh(new_build)
    return new_build
```

**Step 4: Verify passes, then commit**

```bash
pytest tests/backend/api/test_builds_api.py::test_create_build -v
git add backend/app/api/routers/builds.py backend/app/schemas/build_schemas.py
git commit -m "feat: add POST /api/builds endpoint"
```

### Subtask 3.3.1.2: PUT /api/builds/{id} - Update Build

**Step 1: Write test**

```python
def test_update_build(client, sample_build):
    """Test updating an existing build"""
    updates = {"name": "Updated Name", "level": 45}

    response = client.put(f"/api/builds/{sample_build.id}", json=updates)

    assert response.status_code == 200
    assert response.json()['name'] == "Updated Name"
    assert response.json()['level'] == 45
```

**Step 2: Implement**

```python
@router.put("/{build_id}", response_model=BuildResponse)
async def update_build(
    build_id: int,
    updates: BuildUpdate,
    db: Session = Depends(get_db)
):
    """Update a build"""
    build = db.query(Build).filter(Build.id == build_id).first()
    if not build:
        raise HTTPException(status_code=404, detail="Build not found")

    for field, value in updates.dict(exclude_unset=True).items():
        setattr(build, field, value)

    db.commit()
    db.refresh(build)
    return build
```

**Step 3: Test and commit**

```bash
pytest tests/backend/api/test_builds_api.py::test_update_build -v
git add backend/app/api/routers/builds.py
git commit -m "feat: add PUT /api/builds/{id} endpoint"
```

### Subtask 3.3.1.3: DELETE /api/builds/{id} - Delete Build

**Step 1: Write test**

```python
def test_delete_build(client, sample_build):
    """Test deleting a build"""
    response = client.delete(f"/api/builds/{sample_build.id}")

    assert response.status_code == 204

    # Verify deleted
    get_response = client.get(f"/api/builds/{sample_build.id}")
    assert get_response.status_code == 404
```

**Step 2: Implement**

```python
@router.delete("/{build_id}", status_code=204)
async def delete_build(
    build_id: int,
    db: Session = Depends(get_db)
):
    """Delete a build"""
    build = db.query(Build).filter(Build.id == build_id).first()
    if not build:
        raise HTTPException(status_code=404, detail="Build not found")

    db.delete(build)
    db.commit()
```

**Step 3: Test and commit**

```bash
pytest tests/backend/api/test_builds_api.py::test_delete_build -v
git add backend/app/api/routers/builds.py
git commit -m "feat: add DELETE /api/builds/{id} endpoint"
```

---

## Task 3.3.2: Implement Power Slot Operations

### Subtask 3.3.2.1: POST /api/builds/{id}/powers - Add Power to Build

**Step 1: Write test**

```python
def test_add_power_to_build(client, sample_build):
    """Test adding a power to a build"""
    power_data = {
        "power_id": 1,
        "level_taken": 1,
        "slot_number": 1
    }

    response = client.post(f"/api/builds/{sample_build.id}/powers", json=power_data)

    assert response.status_code == 201
    data = response.json()
    assert data['power_id'] == 1
    assert data['level_taken'] == 1
```

**Step 2: Implement**

```python
@router.post("/{build_id}/powers", status_code=201)
async def add_power_to_build(
    build_id: int,
    power_data: PowerSlotCreate,
    db: Session = Depends(get_db)
):
    """Add a power to a build"""
    build = db.query(Build).filter(Build.id == build_id).first()
    if not build:
        raise HTTPException(status_code=404, detail="Build not found")

    power_slot = PowerSlot(
        build_id=build_id,
        power_id=power_data.power_id,
        level_taken=power_data.level_taken,
        slot_number=power_data.slot_number
    )

    db.add(power_slot)
    db.commit()
    db.refresh(power_slot)
    return power_slot
```

**Step 3: Test and commit**

```bash
pytest tests/backend/api/test_builds_api.py::test_add_power_to_build -v
git add backend/app/api/routers/builds.py
git commit -m "feat: add POST /api/builds/{id}/powers endpoint"
```

### Subtask 3.3.2.2: PUT /api/builds/{id}/powers/{slot_id} - Update Power Slot

**Step 1: Write test**

```python
def test_update_power_slot_enhancements(client, sample_build, sample_power_slot):
    """Test updating enhancements in a power slot"""
    updates = {
        "enhancements": [
            {"enhancement_id": 1, "level": 50},
            {"enhancement_id": 2, "level": 50}
        ]
    }

    response = client.put(
        f"/api/builds/{sample_build.id}/powers/{sample_power_slot.id}",
        json=updates
    )

    assert response.status_code == 200
    assert len(response.json()['enhancements']) == 2
```

**Step 2: Implement**

```python
@router.put("/{build_id}/powers/{slot_id}")
async def update_power_slot(
    build_id: int,
    slot_id: int,
    updates: PowerSlotUpdate,
    db: Session = Depends(get_db)
):
    """Update a power slot (primarily for enhancements)"""
    slot = db.query(PowerSlot).filter(
        PowerSlot.id == slot_id,
        PowerSlot.build_id == build_id
    ).first()

    if not slot:
        raise HTTPException(status_code=404, detail="Power slot not found")

    if updates.enhancements:
        # Clear existing enhancements
        db.query(SlottedEnhancement).filter(
            SlottedEnhancement.power_slot_id == slot_id
        ).delete()

        # Add new enhancements
        for enh_data in updates.enhancements:
            slotted_enh = SlottedEnhancement(
                power_slot_id=slot_id,
                enhancement_id=enh_data.enhancement_id,
                level=enh_data.level
            )
            db.add(slotted_enh)

    db.commit()
    db.refresh(slot)
    return slot
```

**Step 3: Test and commit**

```bash
pytest tests/backend/api/test_builds_api.py::test_update_power_slot_enhancements -v
git add backend/app/api/routers/builds.py
git commit -m "feat: add PUT /api/builds/{id}/powers/{slot_id} endpoint"
```

### Subtask 3.3.2.3: DELETE /api/builds/{id}/powers/{slot_id} - Remove Power

**Step 1: Write test, implement, test, commit (following TDD pattern)**

```python
def test_remove_power_from_build(client, sample_build, sample_power_slot):
    """Test removing a power from a build"""
    response = client.delete(
        f"/api/builds/{sample_build.id}/powers/{sample_power_slot.id}"
    )

    assert response.status_code == 204
```

**Implementation and commit**

```python
@router.delete("/{build_id}/powers/{slot_id}", status_code=204)
async def remove_power_from_build(
    build_id: int,
    slot_id: int,
    db: Session = Depends(get_db)
):
    """Remove a power from a build"""
    slot = db.query(PowerSlot).filter(
        PowerSlot.id == slot_id,
        PowerSlot.build_id == build_id
    ).first()

    if not slot:
        raise HTTPException(status_code=404, detail="Power slot not found")

    db.delete(slot)
    db.commit()
```

```bash
git add backend/app/api/routers/builds.py
git commit -m "feat: add DELETE /api/builds/{id}/powers/{slot_id} endpoint"
```

---

## Task 3.3.3: Validation and Error Handling

### Subtask 3.3.3.1: Add Build Validation Rules

**Step 1: Write validation tests**

```python
def test_create_build_invalid_level_fails(client):
    """Test that invalid level (>50) is rejected"""
    build_data = {
        "name": "Invalid Build",
        "archetype_id": 1,
        "level": 60  # Invalid
    }

    response = client.post("/api/builds", json=build_data)
    assert response.status_code == 422


def test_add_duplicate_power_fails(client, sample_build):
    """Test that adding same power twice fails"""
    power_data = {"power_id": 1, "level_taken": 1, "slot_number": 1}

    # Add once
    client.post(f"/api/builds/{sample_build.id}/powers", json=power_data)

    # Add again - should fail
    response = client.post(f"/api/builds/{sample_build.id}/powers", json=power_data)
    assert response.status_code == 400
    assert "already exists" in response.json()['detail'].lower()
```

**Step 2: Implement validation**

```python
from pydantic import validator

class BuildCreate(BaseModel):
    name: str
    archetype_id: int
    level: int = 1
    description: str = ""

    @validator('level')
    def validate_level(cls, v):
        if v < 1 or v > 50:
            raise ValueError('Level must be between 1 and 50')
        return v

# In add_power_to_build endpoint:
existing = db.query(PowerSlot).filter(
    PowerSlot.build_id == build_id,
    PowerSlot.power_id == power_data.power_id
).first()

if existing:
    raise HTTPException(
        status_code=400,
        detail=f"Power {power_data.power_id} already exists in build"
    )
```

**Step 3: Test and commit**

```bash
pytest tests/backend/api/test_builds_api.py -k validation -v
git add backend/app/schemas/build_schemas.py backend/app/api/routers/builds.py
git commit -m "feat: add build validation rules"
```

---

## Final Verification

### Run All Tests

```bash
just test
pytest tests/backend/api/test_builds_api.py -v
```

### Update Progress

```bash
git add .claude/state/progress.json
git commit -m "docs: mark Epic 3.3 complete"
```

### Create PR

```bash
git push -u origin feature/epic-3.3-write-operations
gh pr create --title "Epic 3.3: Build Write/Modify Operations"
```

---

**Estimated Time**: 2 days

**Next Task**: Epic 3.4 - API Testing
