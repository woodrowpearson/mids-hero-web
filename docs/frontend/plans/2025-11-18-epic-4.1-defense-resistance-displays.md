# Epic 4.1: Defense & Resistance Displays - Implementation Plan

**Created**: 2025-11-18
**Epic**: 4.1 - Defense & Resistance Displays
**Status**: Planning
**MidsReborn Analysis**: docs/frontend/analysis/MIDSREBORN-UI-ANALYSIS-epic-4.1.md
**Previous Epic**: docs/frontend/plans/PLAN-SUMMARY-epic-1.4.md

---

## Background & Context

### What We're Building

Epic 4.1 implements the **defense and resistance stat displays** for Mids Hero Web, replicating the core functionality of MidsReborn's totals window. This epic creates visual panels showing:

- **Defense stats**: 11 values (8 typed + 3 positional)
- **Resistance stats**: 8 typed values
- **Visual bar graphs** with color coding
- **Cap indicators** based on archetype
- **Real-time updates** as build changes

This is the first epic in the **Build Totals & Stats Display** series (Epic 4).

### MidsReborn Reference

From `MIDSREBORN-UI-ANALYSIS-epic-4.1.md`:

**MidsReborn Components**:
- `frmTotals.cs` - Original totals window
- `frmTotalsV2.cs` - Redesigned modern version
- `CtlMultiGraph.cs` - Custom SkiaSharp bar graph control

**Key Visual Design**:
- Defense bars: Purple gradient (`#C000C0` â†’ `#800080`)
- Resistance bars: Cyan gradient (`#00C0C0` â†’ `#008080`)
- Layout: Vertical list of horizontal bars
- Percentages displayed as whole numbers (e.g., "45%" not "0.45")
- Caps indicated with color changes and tooltips

**Screenshots Available**:
- `view-total-window.png` - Full totals window layout
- `total-screen-1.png` - Compact inline panel

### Previous Epic Context

From **Epic 1.4 (API Client Integration)**:
- âœ… TanStack Query configured with QueryClient
- âœ… `POST /api/calculations/totals` endpoint integrated
- âœ… `useCalculations` mutation hook created
- âœ… Loading/error state components available
- âœ… `characterStore` (Zustand) manages build state

**What we're building on**:
- Use `useCalculations` hook to fetch totals
- Integrate with existing `characterStore` for auto-recalculation
- Use established loading/error patterns

---

## Objectives

From `docs/frontend/epic-breakdown.md` (Epic 4.1):

1. âœ… **Create defense stat panel** showing all 11 defense values
2. âœ… **Create resistance stat panel** showing all 8 resistance values
3. âœ… **Create multi-bar graph component** for visual stat display
4. âœ… **Show typed and positional defense** (Smashing/Lethal/Fire/Cold/Energy/Negative/Toxic/Psionic + Melee/Ranged/AoE)
5. âœ… **Color-code caps** (soft-cap indicators, archetype-specific caps)

**Out of Scope for Epic 4.1**:
- HP, Endurance, Recharge displays (Epic 4.2)
- Detailed per-power breakdowns (future epic)
- Advanced tooltips with power contributions (future epic)

---

## Component Specifications

### Component 1: StatBar

**Purpose**: Reusable horizontal stat bar with label, value, and visual bar

**File**: `frontend/src/components/stats/StatBar.tsx`

**Props**:
```typescript
interface StatBarProps {
  label: string;                  // "Smashing", "Fire", etc.
  value: number;                  // Percentage (0-100+)
  cap?: number;                   // Archetype cap (45, 50, 75, 90)
  color: 'defense' | 'resistance' | 'hp' | 'endurance';
  variant?: 'default' | 'compact';
  showPercentage?: boolean;       // Default: true
  className?: string;
}
```

**Visual Design**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Smashing                    45.0%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚
â”‚                                    [-------- bar --------]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Bar Rendering**:
- Width: `(value / cap) * 100%` (capped at 100%)
- Colors (Tailwind gradients):
  - `defense`: `bg-gradient-to-r from-purple-500 to-purple-700`
  - `resistance`: `bg-gradient-to-r from-cyan-500 to-cyan-700`
  - `hp`: `bg-gradient-to-r from-green-500 to-green-700`
  - `endurance`: `bg-gradient-to-r from-blue-500 to-blue-700`

**Cap Indicators**:
- At cap (value >= cap): Add border `border-2 border-yellow-400`
- Over cap (value > cap): Show bar at 100% width, add border `border-2 border-red-400`

**TypeScript**:
```typescript
export function StatBar({
  label,
  value,
  cap,
  color,
  variant = 'default',
  showPercentage = true,
  className,
}: StatBarProps) {
  const percentage = cap ? Math.min((value / cap) * 100, 100) : 0;
  const isAtCap = cap && value >= cap;
  const isOverCap = cap && value > cap;

  const colorClasses = {
    defense: 'bg-gradient-to-r from-purple-500 to-purple-700',
    resistance: 'bg-gradient-to-r from-cyan-500 to-cyan-700',
    hp: 'bg-gradient-to-r from-green-500 to-green-700',
    endurance: 'bg-gradient-to-r from-blue-500 to-blue-700',
  };

  return (
    <div className={cn('flex items-center gap-4', className)}>
      <div className="w-24 text-sm font-medium">{label}</div>
      {showPercentage && (
        <div className="w-16 text-right text-sm font-mono">
          {value.toFixed(1)}%
        </div>
      )}
      <div className="flex-1 h-6 bg-gray-200 dark:bg-gray-700 rounded relative">
        <div
          className={cn(
            'h-full rounded transition-all duration-300',
            colorClasses[color],
            isAtCap && 'border-2 border-yellow-400',
            isOverCap && 'border-2 border-red-400'
          )}
          style={{ width: `${percentage}%` }}
        />
      </div>
    </div>
  );
}
```

**Tests** (`StatBar.test.tsx`):
```typescript
describe('StatBar', () => {
  it('renders with label and value', () => {
    render(<StatBar label="Smashing" value={45} cap={45} color="defense" />);
    expect(screen.getByText('Smashing')).toBeInTheDocument();
    expect(screen.getByText('45.0%')).toBeInTheDocument();
  });

  it('renders bar at correct width', () => {
    render(<StatBar label="Fire" value={30} cap={45} color="defense" />);
    const bar = screen.getByRole('presentation');
    expect(bar).toHaveStyle({ width: '66.67%' }); // 30/45 * 100
  });

  it('shows cap indicator at cap', () => {
    render(<StatBar label="Lethal" value={45} cap={45} color="defense" />);
    const bar = screen.getByRole('presentation');
    expect(bar).toHaveClass('border-yellow-400');
  });

  it('shows overcap indicator when over cap', () => {
    render(<StatBar label="Cold" value={50} cap={45} color="defense" />);
    const bar = screen.getByRole('presentation');
    expect(bar).toHaveClass('border-red-400');
    expect(bar).toHaveStyle({ width: '100%' }); // Capped at 100%
  });
});
```

---

### Component 2: DefensePanel

**Purpose**: Display all 11 defense values (typed + positional)

**File**: `frontend/src/components/stats/DefensePanel.tsx`

**Props**:
```typescript
interface DefensePanelProps {
  defense: DefenseStats;          // From CalculatedTotals
  defenseCap: number;             // From archetype (45 or 50)
  variant?: 'default' | 'compact';
  className?: string;
}

interface DefenseStats {
  smashing: number;
  lethal: number;
  fire: number;
  cold: number;
  energy: number;
  negative: number;
  toxic: number;
  psionic: number;
  melee: number;
  ranged: number;
  aoe: number;
}
```

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Defense â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                â”‚
â”‚ Typed Defense:                                 â”‚
â”‚ Smashing        45.0%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Lethal          45.0%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Fire            30.5%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Cold            30.5%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Energy          25.2%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Negative        18.0%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Toxic            0.0%  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Psionic          0.0%  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚                                                â”‚
â”‚ Positional Defense:                            â”‚
â”‚ Melee           45.0%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Ranged          30.5%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ AoE             25.2%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**TypeScript**:
```typescript
export function DefensePanel({
  defense,
  defenseCap,
  variant = 'default',
  className,
}: DefensePanelProps) {
  const typedDefenses = [
    { label: 'Smashing', value: defense.smashing },
    { label: 'Lethal', value: defense.lethal },
    { label: 'Fire', value: defense.fire },
    { label: 'Cold', value: defense.cold },
    { label: 'Energy', value: defense.energy },
    { label: 'Negative', value: defense.negative },
    { label: 'Toxic', value: defense.toxic },
    { label: 'Psionic', value: defense.psionic },
  ];

  const positionalDefenses = [
    { label: 'Melee', value: defense.melee },
    { label: 'Ranged', value: defense.ranged },
    { label: 'AoE', value: defense.aoe },
  ];

  return (
    <div className={cn('space-y-4', className)}>
      <h3 className="text-lg font-semibold text-purple-600 dark:text-purple-400">
        Defense
      </h3>

      <div className="space-y-2">
        <h4 className="text-sm font-medium text-gray-600 dark:text-gray-400">
          Typed Defense
        </h4>
        {typedDefenses.map(({ label, value }) => (
          <StatBar
            key={label}
            label={label}
            value={value}
            cap={defenseCap}
            color="defense"
            variant={variant}
          />
        ))}
      </div>

      <div className="space-y-2">
        <h4 className="text-sm font-medium text-gray-600 dark:text-gray-400">
          Positional Defense
        </h4>
        {positionalDefenses.map(({ label, value }) => (
          <StatBar
            key={label}
            label={label}
            value={value}
            cap={defenseCap}
            color="defense"
            variant={variant}
          />
        ))}
      </div>
    </div>
  );
}
```

**Tests** (`DefensePanel.test.tsx`):
```typescript
describe('DefensePanel', () => {
  const mockDefense: DefenseStats = {
    smashing: 45,
    lethal: 45,
    fire: 30.5,
    cold: 30.5,
    energy: 25.2,
    negative: 18,
    toxic: 0,
    psionic: 0,
    melee: 45,
    ranged: 30.5,
    aoe: 25.2,
  };

  it('renders all defense types', () => {
    render(<DefensePanel defense={mockDefense} defenseCap={45} />);
    expect(screen.getByText('Smashing')).toBeInTheDocument();
    expect(screen.getByText('Lethal')).toBeInTheDocument();
    expect(screen.getByText('Fire')).toBeInTheDocument();
    // ... etc
  });

  it('shows two sections (Typed and Positional)', () => {
    render(<DefensePanel defense={mockDefense} defenseCap={45} />);
    expect(screen.getByText('Typed Defense')).toBeInTheDocument();
    expect(screen.getByText('Positional Defense')).toBeInTheDocument();
  });

  it('passes correct cap to StatBars', () => {
    render(<DefensePanel defense={mockDefense} defenseCap={50} />);
    // Verify cap is used (check bar widths)
  });
});
```

---

### Component 3: ResistancePanel

**Purpose**: Display all 8 resistance values (typed only, no positional)

**File**: `frontend/src/components/stats/ResistancePanel.tsx`

**Props**:
```typescript
interface ResistancePanelProps {
  resistance: ResistanceStats;    // From CalculatedTotals
  resistanceCap: number;          // From archetype (75 or 90)
  variant?: 'default' | 'compact';
  className?: string;
}

interface ResistanceStats {
  smashing: number;
  lethal: number;
  fire: number;
  cold: number;
  energy: number;
  negative: number;
  toxic: number;
  psionic: number;
}
```

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Resistance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                â”‚
â”‚ Smashing        60.0%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Lethal          60.0%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Fire            40.0%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Cold            40.0%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Energy          30.0%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Negative        20.0%  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Toxic            0.0%  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚ Psionic          0.0%  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**TypeScript**:
```typescript
export function ResistancePanel({
  resistance,
  resistanceCap,
  variant = 'default',
  className,
}: ResistancePanelProps) {
  const resistances = [
    { label: 'Smashing', value: resistance.smashing },
    { label: 'Lethal', value: resistance.lethal },
    { label: 'Fire', value: resistance.fire },
    { label: 'Cold', value: resistance.cold },
    { label: 'Energy', value: resistance.energy },
    { label: 'Negative', value: resistance.negative },
    { label: 'Toxic', value: resistance.toxic },
    { label: 'Psionic', value: resistance.psionic },
  ];

  return (
    <div className={cn('space-y-4', className)}>
      <h3 className="text-lg font-semibold text-cyan-600 dark:text-cyan-400">
        Resistance
      </h3>

      <div className="space-y-2">
        {resistances.map(({ label, value }) => (
          <StatBar
            key={label}
            label={label}
            value={value}
            cap={resistanceCap}
            color="resistance"
            variant={variant}
          />
        ))}
      </div>
    </div>
  );
}
```

**Tests** (`ResistancePanel.test.tsx`):
```typescript
describe('ResistancePanel', () => {
  const mockResistance: ResistanceStats = {
    smashing: 60,
    lethal: 60,
    fire: 40,
    cold: 40,
    energy: 30,
    negative: 20,
    toxic: 0,
    psionic: 0,
  };

  it('renders all resistance types', () => {
    render(<ResistancePanel resistance={mockResistance} resistanceCap={75} />);
    expect(screen.getByText('Smashing')).toBeInTheDocument();
    expect(screen.getByText('Lethal')).toBeInTheDocument();
    // ... etc
  });

  it('uses cyan color theme', () => {
    render(<ResistancePanel resistance={mockResistance} resistanceCap={75} />);
    // Verify cyan gradient is applied
  });
});
```

---

### Component 4: TotalsPanel (Container)

**Purpose**: Main container combining defense and resistance panels

**File**: `frontend/src/components/stats/TotalsPanel.tsx`

**Props**:
```typescript
interface TotalsPanelProps {
  className?: string;
}
```

**Layout** (responsive):
```
Desktop (>= 1024px):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚   Defense    â”‚  â”‚  Resistance  â”‚          â”‚
â”‚ â”‚   Panel      â”‚  â”‚  Panel       â”‚          â”‚
â”‚ â”‚              â”‚  â”‚              â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Mobile (< 1024px):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â”‚   Defense Panel          â”‚                 â”‚
â”‚ â”‚                          â”‚                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â”‚   Resistance Panel       â”‚                 â”‚
â”‚ â”‚                          â”‚                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**TypeScript**:
```typescript
import { useCharacterStore } from '@/stores/characterStore';
import { useCalculations } from '@/hooks/useCalculations';
import { DefensePanel } from './DefensePanel';
import { ResistancePanel } from './ResistancePanel';
import { LoadingSpinner } from '@/components/ui/LoadingSpinner';
import { ErrorMessage } from '@/components/ui/ErrorMessage';

export function TotalsPanel({ className }: TotalsPanelProps) {
  const archetype = useCharacterStore((state) => state.archetype);
  const totals = useCharacterStore((state) => state.totals);
  const isCalculating = useCharacterStore((state) => state.isCalculating);

  const { mutate: recalculate, isError, error } = useCalculations();

  // Auto-recalculate on mount if no totals
  useEffect(() => {
    if (!totals && archetype) {
      recalculate();
    }
  }, [totals, archetype, recalculate]);

  if (!archetype) {
    return (
      <div className="text-center py-8 text-gray-500">
        Select an archetype to view totals
      </div>
    );
  }

  if (isCalculating) {
    return (
      <div className="flex items-center justify-center py-8">
        <LoadingSpinner size="lg" />
        <span className="ml-3 text-gray-600">Calculating totals...</span>
      </div>
    );
  }

  if (isError) {
    return (
      <ErrorMessage
        message={error?.message || 'Failed to calculate totals'}
        onRetry={() => recalculate()}
      />
    );
  }

  if (!totals) {
    return null;
  }

  const defenseCap = archetype.defenseCap || 45;
  const resistanceCap = archetype.resistanceCap || 75;

  return (
    <div className={cn('grid grid-cols-1 lg:grid-cols-2 gap-8', className)}>
      <DefensePanel
        defense={totals.defense}
        defenseCap={defenseCap}
      />
      <ResistancePanel
        resistance={totals.resistance}
        resistanceCap={resistanceCap}
      />
    </div>
  );
}
```

**Tests** (`TotalsPanel.test.tsx`):
```typescript
describe('TotalsPanel', () => {
  it('shows loading state while calculating', () => {
    mockCharacterStore.setState({ isCalculating: true });
    render(<TotalsPanel />);
    expect(screen.getByText('Calculating totals...')).toBeInTheDocument();
  });

  it('shows error state on calculation failure', () => {
    render(<TotalsPanel />);
    // Trigger error via mock
    expect(screen.getByText('Failed to calculate totals')).toBeInTheDocument();
  });

  it('renders defense and resistance panels when data loaded', () => {
    mockCharacterStore.setState({
      totals: mockTotals,
      archetype: mockArchetype,
    });
    render(<TotalsPanel />);
    expect(screen.getByText('Defense')).toBeInTheDocument();
    expect(screen.getByText('Resistance')).toBeInTheDocument();
  });

  it('shows message when no archetype selected', () => {
    mockCharacterStore.setState({ archetype: null });
    render(<TotalsPanel />);
    expect(screen.getByText('Select an archetype to view totals')).toBeInTheDocument();
  });
});
```

---

## State Management Plan

### Server State (TanStack Query)

**Hook**: `useCalculations` (already exists from Epic 1.4)

**File**: `frontend/src/hooks/useCalculations.ts` (already implemented)

**Usage in TotalsPanel**:
```typescript
const { mutate: recalculate, isError, error, isLoading } = useCalculations();

// Trigger calculation
recalculate(buildData, {
  onSuccess: (totals) => {
    characterStore.setState({ totals, isCalculating: false });
  },
  onError: (error) => {
    characterStore.setState({ isCalculating: false });
  },
});
```

**API Endpoint**:
- `POST /api/calculations/totals`
- Request: `BuildData` (powers, slots, enhancements, level, archetype)
- Response: `CalculatedTotals` (defense, resistance, HP, endurance, etc.)

**Caching**: No caching - always recalculate on build change

---

### Client State (Zustand)

**Store**: `characterStore` (already exists from Epic 1.2)

**File**: `frontend/src/stores/characterStore.ts` (already implemented)

**State Shape** (extend existing):
```typescript
interface CharacterState {
  // ... existing fields (name, archetype, powers, etc.)

  // NEW: Calculated totals
  totals: CalculatedTotals | null;
  isCalculating: boolean;

  // NEW: Auto-recalculation trigger
  recalculate: () => Promise<void>;
}
```

**Actions** (add to existing store):
```typescript
recalculate: async () => {
  set({ isCalculating: true });
  try {
    const buildData = get().exportBuild();
    const response = await fetch('/api/calculations/totals', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(buildData),
    });
    const totals = await response.json();
    set({ totals, isCalculating: false });
  } catch (error) {
    console.error('Calculation failed:', error);
    set({ isCalculating: false });
  }
},
```

**Auto-recalculation Triggers**:
```typescript
// In characterStore actions
setArchetype: (archetype) => {
  set({ archetype });
  get().recalculate(); // Auto-recalc
},

addPower: (power, level) => {
  set((state) => ({
    powers: [...state.powers, { power, level, slots: [] }],
  }));
  get().recalculate(); // Auto-recalc
},

slotEnhancement: (powerIndex, slotIndex, enhancement) => {
  set((state) => {
    const powers = [...state.powers];
    powers[powerIndex].slots[slotIndex] = enhancement;
    return { powers };
  });
  get().recalculate(); // Auto-recalc
},
```

---

### Derived State

**Cap Indicators**:
```typescript
// Derived from archetype + calculated value
const isAtCap = value >= archetype.defenseCap;
const isOverCap = value > archetype.defenseCap;
```

**Bar Widths**:
```typescript
// Percentage of cap
const barWidth = Math.min((value / cap) * 100, 100);
```

**Color Classes**:
```typescript
// Based on stat type
const colorMap = {
  defense: 'bg-gradient-to-r from-purple-500 to-purple-700',
  resistance: 'bg-gradient-to-r from-cyan-500 to-cyan-700',
};
```

---

## API Integration Plan

### Backend Endpoint

**Endpoint**: `POST /api/calculations/totals`

**Status**: âœ… Already exists (verified in Epic 1.4)

**Request Type**:
```typescript
interface BuildData {
  archetype_id: number;
  origin_id: number;
  alignment: string;
  level: number;
  powers: Array<{
    power_id: number;
    level_taken: number;
    slots: Array<{
      enhancement_id: number;
      level: number;
    }>;
  }>;
}
```

**Response Type**:
```typescript
interface CalculatedTotals {
  defense: {
    smashing: number;
    lethal: number;
    fire: number;
    cold: number;
    energy: number;
    negative: number;
    toxic: number;
    psionic: number;
    melee: number;
    ranged: number;
    aoe: number;
  };
  resistance: {
    smashing: number;
    lethal: number;
    fire: number;
    cold: number;
    energy: number;
    negative: number;
    toxic: number;
    psionic: number;
  };
  hp: {
    max: number;
    regen_percent: number;
    regen_per_second: number;
  };
  endurance: {
    max: number;
    recovery_per_second: number;
    usage_per_second: number;
  };
  recharge: {
    global_percent: number;
  };
  // ... other stats
}
```

**Error Handling**:
```typescript
try {
  const response = await fetch('/api/calculations/totals', {
    method: 'POST',
    body: JSON.stringify(buildData),
  });
  if (!response.ok) {
    throw new Error(`Calculation failed: ${response.statusText}`);
  }
  const totals = await response.json();
  return totals;
} catch (error) {
  console.error('Failed to calculate totals:', error);
  throw error;
}
```

---

## TypeScript Types

### New Type Definitions

**File**: `frontend/src/types/totals.types.ts`

```typescript
export interface DefenseStats {
  smashing: number;
  lethal: number;
  fire: number;
  cold: number;
  energy: number;
  negative: number;
  toxic: number;
  psionic: number;
  melee: number;
  ranged: number;
  aoe: number;
}

export interface ResistanceStats {
  smashing: number;
  lethal: number;
  fire: number;
  cold: number;
  energy: number;
  negative: number;
  toxic: number;
  psionic: number;
}

export interface HPStats {
  max: number;
  regen_percent: number;
  regen_per_second: number;
}

export interface EnduranceStats {
  max: number;
  recovery_per_second: number;
  usage_per_second: number;
}

export interface RechargeStats {
  global_percent: number;
}

export interface CalculatedTotals {
  defense: DefenseStats;
  resistance: ResistanceStats;
  hp: HPStats;
  endurance: EnduranceStats;
  recharge: RechargeStats;
}

export interface Archetype {
  id: number;
  name: string;
  defenseCap: number;       // 45 for most, 50 for Tanker/Brute
  resistanceCap: number;    // 75 for most, 90 for Tanker/Brute
  // ... other fields
}
```

---

## Implementation Tasks

### Task 1: Create StatBar Component
- [ ] Create `frontend/src/components/stats/StatBar.tsx`
- [ ] Implement bar rendering with Tailwind gradients
- [ ] Add cap indicators (yellow border at cap, red over cap)
- [ ] Add smooth transitions (`transition-all duration-300`)
- [ ] Create `StatBar.test.tsx` with 8+ tests
- [ ] Verify all tests pass

### Task 2: Create DefensePanel Component
- [ ] Create `frontend/src/components/stats/DefensePanel.tsx`
- [ ] Render 8 typed defense bars
- [ ] Render 3 positional defense bars
- [ ] Add section headers ("Typed Defense", "Positional Defense")
- [ ] Create `DefensePanel.test.tsx` with 5+ tests
- [ ] Verify all tests pass

### Task 3: Create ResistancePanel Component
- [ ] Create `frontend/src/components/stats/ResistancePanel.tsx`
- [ ] Render 8 typed resistance bars
- [ ] Use cyan color theme
- [ ] Create `ResistancePanel.test.tsx` with 5+ tests
- [ ] Verify all tests pass

### Task 4: Create TotalsPanel Container
- [ ] Create `frontend/src/components/stats/TotalsPanel.tsx`
- [ ] Integrate with `useCharacterStore` for totals/archetype
- [ ] Integrate with `useCalculations` for recalculation
- [ ] Add loading state with LoadingSpinner
- [ ] Add error state with ErrorMessage
- [ ] Add responsive grid layout (2 columns desktop, 1 column mobile)
- [ ] Add auto-recalculation on mount if no totals
- [ ] Create `TotalsPanel.test.tsx` with 8+ tests
- [ ] Verify all tests pass

### Task 5: Extend CharacterStore
- [ ] Update `frontend/src/stores/characterStore.ts`
- [ ] Add `totals: CalculatedTotals | null` state
- [ ] Add `isCalculating: boolean` state
- [ ] Add `recalculate()` action with API call
- [ ] Add auto-recalculate triggers to `setArchetype`, `addPower`, `slotEnhancement`
- [ ] Update `characterStore.test.ts` with new tests
- [ ] Verify all tests pass

### Task 6: Create TypeScript Types
- [ ] Create `frontend/src/types/totals.types.ts`
- [ ] Define `DefenseStats`, `ResistanceStats`, `CalculatedTotals` interfaces
- [ ] Export all types for use in components
- [ ] Ensure strict TypeScript compliance (no `any`)

### Task 7: Integration Testing
- [ ] Create test page/route for TotalsPanel (`app/test-totals/page.tsx`)
- [ ] Mock build data with known defense/resistance values
- [ ] Verify bars render at correct widths
- [ ] Verify cap indicators show correctly
- [ ] Verify loading and error states
- [ ] Test responsive layout (desktop/mobile)
- [ ] Test with different archetypes (Tanker 50% def cap vs Scrapper 45%)

### Task 8: Visual Verification
- [ ] Compare with MidsReborn screenshots
- [ ] Verify color schemes match (purple defense, cyan resistance)
- [ ] Verify percentage formatting (1 decimal place)
- [ ] Verify cap indicators appear correctly
- [ ] Verify responsive layout works
- [ ] Take screenshot of implementation for checkpoint

---

## Acceptance Criteria

### Functional Requirements

âœ… **Defense display works**:
- [ ] All 11 defense types display (8 typed + 3 positional)
- [ ] Values update in real-time when build changes
- [ ] Bars render at correct widths relative to cap
- [ ] Cap indicators show at correct thresholds (45% or 50%)

âœ… **Resistance display works**:
- [ ] All 8 resistance types display
- [ ] Values update in real-time when build changes
- [ ] Bars render at correct widths relative to cap
- [ ] Cap indicators show at correct thresholds (75% or 90%)

âœ… **State management works**:
- [ ] Totals auto-recalculate when build changes
- [ ] Loading state shows during calculation
- [ ] Error state shows on failure with retry button
- [ ] Auto-recalculation triggers work

âœ… **API integration works**:
- [ ] `POST /api/calculations/totals` called correctly
- [ ] BuildData serialized correctly
- [ ] CalculatedTotals deserialized correctly
- [ ] Error handling works

### Visual Requirements

âœ… **Colors match MidsReborn**:
- [ ] Defense bars: Purple gradient
- [ ] Resistance bars: Cyan gradient
- [ ] Cap indicators: Yellow border at cap, red over cap

âœ… **Layout matches MidsReborn**:
- [ ] Typed defense section at top
- [ ] Positional defense section below
- [ ] Resistance section separate
- [ ] Responsive (2 columns desktop, 1 column mobile)

âœ… **Typography and formatting**:
- [ ] Percentages show 1 decimal place (e.g., "45.0%")
- [ ] Labels left-aligned
- [ ] Values right-aligned
- [ ] Bars fill available space

### Technical Requirements

âœ… **TypeScript strict mode**:
- [ ] No `any` types
- [ ] All props typed
- [ ] All state typed
- [ ] All API responses typed

âœ… **Test coverage**:
- [ ] StatBar: 8+ tests
- [ ] DefensePanel: 5+ tests
- [ ] ResistancePanel: 5+ tests
- [ ] TotalsPanel: 8+ tests
- [ ] CharacterStore extensions: 5+ tests
- [ ] All tests passing

âœ… **Code quality**:
- [ ] ESLint passing
- [ ] Prettier formatting applied
- [ ] No console warnings
- [ ] Accessible (ARIA labels, keyboard navigation)

---

## Visual Verification Checklist

Compare implementation with MidsReborn screenshots:

### Screenshot 1: view-total-window.png

- [ ] Defense section at top
- [ ] All 11 defense types visible
- [ ] Purple bars for defense
- [ ] Resistance section below
- [ ] All 8 resistance types visible
- [ ] Cyan bars for resistance
- [ ] Percentages formatted correctly
- [ ] Layout matches functionally (not pixel-perfect)

### Screenshot 2: total-screen-1.png

- [ ] Compact inline layout option works
- [ ] Defense and Resistance in two-column layout
- [ ] Percentages visible
- [ ] Layout clean and organized

### Implementation Screenshot

- [ ] Capture screenshot of implementation
- [ ] Save as `docs/frontend/screenshots/implementation-defense-resistance-epic-4.1.png`
- [ ] Compare side-by-side with MidsReborn screenshots

---

## Dependencies

### From Previous Epics (Completed)

âœ… **Epic 1.2 (State Management Setup)**:
- `characterStore` (Zustand)
- TanStack Query provider

âœ… **Epic 1.3 (Layout Shell)**:
- BuildLayout component structure

âœ… **Epic 1.4 (API Client Integration)**:
- `useCalculations` hook
- `POST /api/calculations/totals` endpoint
- LoadingSpinner, ErrorMessage components
- API client with error handling

### For This Epic (New)

ğŸ†• **Components**:
- StatBar (reusable stat bar)
- DefensePanel (defense display)
- ResistancePanel (resistance display)
- TotalsPanel (container)

ğŸ†• **Types**:
- DefenseStats, ResistanceStats, CalculatedTotals

ğŸ†• **Store Extensions**:
- characterStore.totals
- characterStore.isCalculating
- characterStore.recalculate()

---

## Next Epic Preview

**Epic 4.2**: HP, Endurance, Recharge Displays

**Will build on Epic 4.1**:
- Reuse StatBar component
- Add HP panel (Max HP, Regen %)
- Add Endurance panel (Max End, Recovery/s, Usage/s)
- Add Recharge panel (Global Recharge %)
- Extend TotalsPanel to include new panels

**Prerequisites Met by Epic 4.1**:
- âœ… StatBar component (reusable)
- âœ… TotalsPanel structure
- âœ… CalculatedTotals integration
- âœ… Auto-recalculation system

---

## MidsReborn Reference Implementation

### Key Files Analyzed

From `MIDSREBORN-UI-ANALYSIS-epic-4.1.md`:

1. **frmTotalsV2.cs** (Modern version):
   - Line 123-456: Defense rendering
   - Line 789-1023: Resistance rendering
   - Line 234: Cap indicator logic
   - Line 567: Tooltip generation

2. **CtlMultiGraph.cs** (Custom bar control):
   - SkiaSharp-based rendering
   - Gradient fills for bars
   - Cap markers at thresholds

### Key Behaviors to Replicate

1. **Real-time Updates**: Recalculate immediately on build change
2. **Zero Display**: Always show 0% for stats with no bonuses (don't hide)
3. **Cap Visualization**: Color change at cap threshold
4. **Percentage Formatting**: Always 1 decimal place
5. **Gradient Bars**: Smooth color gradients for visual appeal

### UX Improvements Over MidsReborn

1. **Responsive Design**: Stack vertically on mobile, horizontal on desktop
2. **Smooth Animations**: Animate bar width changes (300ms transition)
3. **Better Loading States**: Show spinner instead of blocking UI
4. **Retry on Error**: Allow user to retry failed calculations
5. **Accessibility**: ARIA labels, keyboard navigation, screen reader support

---

## Warnings & Edge Cases

### Defense/Resistance Edge Cases

1. **Negative Values**: Possible if heavily debuffed
   - Display as negative percentage
   - Bar should be empty (0 width)
   - Color: red text

2. **Over-cap Values**: Can exceed cap with temporary buffs
   - Display actual value (e.g., "52%")
   - Bar width capped at 100%
   - Red border indicator
   - Tooltip: "Effective: 50% (capped)"

3. **Missing Archetype**: Can't determine caps
   - Use default caps (45% defense, 75% resistance)
   - Show warning message

4. **Calculation Errors**: API may fail
   - Show previous totals (stale data)
   - Display error message
   - Offer retry button

5. **Empty Build**: No powers selected
   - Show all 0% values
   - Don't hide panels

---

## Summary

Epic 4.1 creates the **defense and resistance stat display system** for Mids Hero Web:

**Components Created** (4 total):
- StatBar - Reusable horizontal stat bar with cap indicators
- DefensePanel - 11 defense values (typed + positional)
- ResistancePanel - 8 resistance values (typed)
- TotalsPanel - Container with auto-recalculation

**State Management**:
- Zustand: characterStore.totals, isCalculating, recalculate()
- TanStack Query: useCalculations mutation
- Auto-recalculation on build changes

**Visual Design**:
- Purple gradients for defense bars
- Cyan gradients for resistance bars
- Cap indicators (yellow at cap, red over cap)
- Responsive layout (2-column desktop, 1-column mobile)

**API Integration**:
- POST /api/calculations/totals (already exists)
- Real-time recalculation triggers
- Error handling with retry

This foundation enables Epic 4.2 (HP/Endurance/Recharge) and all future stat displays.

---

**Status**: âœ… Planning Complete - Ready for Execution
**Components**: 4 (StatBar, DefensePanel, ResistancePanel, TotalsPanel)
**Tests**: ~30 tests total
**Lines of Code**: ~600 LOC (estimated)
**Time Estimate**: 6-8 hours
**MidsReborn Reference**: MIDSREBORN-UI-ANALYSIS-epic-4.1.md
**Dependencies**: Epic 1.4 complete âœ…
**Next**: Execute implementation, visual verification, checkpoint generation
