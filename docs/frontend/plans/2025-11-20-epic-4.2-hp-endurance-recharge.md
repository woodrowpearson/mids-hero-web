# Epic 4.2: HP, Endurance, Recharge Displays - Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement HP, Endurance, and Recharge stat display panels for the Mids Hero Web build totals system, reusing the StatBar component from Epic 4.1.

**Architecture:** Extend the TotalsPanel container from Epic 4.1 to include four new panels: HPPanel (regeneration, max HP, absorb), EndurancePanel (recovery, usage, max endurance with net recovery calculation), RechargePanel (global recharge percentage with perma-Hasten indicator), and MiscStatsPanel (accuracy, tohit, damage). Each panel uses multiple StatBar components with appropriate color schemes and displays calculated values from the backend API.

**Tech Stack:** React, TypeScript, Tailwind CSS, TanStack Query, Zustand, shadcn/ui (Tooltip), Framer Motion (animations)

---

## Background & Context

**Previous Work (Epic 4.1):**
- ✅ Created StatBar component (reusable horizontal stat bar)
- ✅ Created DefensePanel (11 defense bars) and ResistancePanel (8 resistance bars)
- ✅ Created TotalsPanel container with auto-recalculation
- ✅ Integrated with POST /api/calculations/totals endpoint
- ✅ Extended characterStore with totals state and recalculate() action

**Epic 4.2 builds on this by:**
- Reusing StatBar component for HP/Endurance/Recharge/Misc stats
- Extending TotalsPanel to include new panels
- Using same auto-recalculation system
- Maintaining visual consistency (color themes, layout)

**MidsReborn Reference:**
- Analysis: `docs/frontend/analysis/MIDSREBORN-UI-ANALYSIS-epic-4.2.md`
- Screenshots: `view-total-window.png` shows HP (green bars) and Endurance (blue bars) sections
- Color scheme: Green (HP), Blue (Endurance), Purple (Recharge)

**Calculation Specifications:**
- Endurance: `docs/midsreborn/calculations/06-power-endurance-recovery.md`
- Recharge: `docs/midsreborn/calculations/21-build-totals-recharge.md`

---

## Task 1: Create TypeScript Types for HP/Endurance/Recharge

**Files:**
- Create: `frontend/src/types/totals.types.ts` (extend existing from Epic 4.1)

**Step 1: Add HP/Endurance/Recharge types to existing totals.types.ts**

Add these interfaces to the existing file created in Epic 4.1:

```typescript
// HP/Health Stats (add to existing file)
export interface HPStats {
  maxHp: number;              // Numeric max HP (e.g., 1205)
  regenerationPercent: number; // Regeneration as percentage (e.g., 140 for 140%)
  hpPerSecond: number;        // HP regenerated per second (e.g., 2.8)
  absorb: number;             // Absorb shield amount (0 if none)
  timeToFull: number;         // Seconds to heal from 0 to max
}

// Endurance Stats (add to existing file)
export interface EnduranceStats {
  maxEndurance: number;        // Numeric max endurance (e.g., 100)
  recoveryNumeric: number;     // End recovered per second (e.g., 2.08)
  recoveryPercent: number;     // Recovery as percentage (e.g., 125 for 125%)
  usage: number;               // End used per second from toggles (e.g., 0.52)
  netRecovery: number;         // Recovery - Usage (can be negative)
  isPositive: boolean;         // True if net recovery > 0
  timeToFull: number;          // Seconds to recover from 0 to max
  timeToZero?: number;         // Seconds to drain (only if negative)
}

// Recharge Stats (add to existing file)
export interface RechargeStats {
  globalPercent: number;       // Global recharge as percentage (e.g., 170 for +70%)
  isCapped: boolean;           // True if at archetype cap (usually 400%)
  permaHasten: boolean;        // True if achieves permanent Hasten
  uncappedPercent?: number;    // Uncapped value if exceeds cap
}

// Misc Buff Stats (add to existing file)
export interface MiscBuffStats {
  accuracy: number;            // Accuracy bonus percentage (base 0%)
  tohit: number;               // ToHit bonus percentage (base 0%)
  damagePercent: number;       // Damage bonus percentage (base 100%)
}

// Extend CalculatedTotals interface (already exists from Epic 4.1)
export interface CalculatedTotals {
  defense: DefenseStats;       // From Epic 4.1
  resistance: ResistanceStats; // From Epic 4.1
  hp: HPStats;                 // NEW for Epic 4.2
  endurance: EnduranceStats;   // NEW for Epic 4.2
  recharge: RechargeStats;     // NEW for Epic 4.2
  buffs: MiscBuffStats;        // NEW for Epic 4.2
}
```

**Step 2: Run TypeScript check**

Run: `cd frontend && npm run type-check`
Expected: No type errors

**Step 3: Commit**

```bash
git add frontend/src/types/totals.types.ts
git commit -m "feat(epic-4.2): add HP/Endurance/Recharge types"
```

---

## Task 2: Create HPPanel Component

**Files:**
- Create: `frontend/src/components/stats/HPPanel.tsx`
- Create: `frontend/src/components/stats/HPPanel.test.tsx`

**Step 1: Write failing test for HPPanel**

Create `frontend/src/components/stats/HPPanel.test.tsx`:

```typescript
import { render, screen } from '@testing-library/react';
import { HPPanel } from './HPPanel';
import type { HPStats } from '@/types/totals.types';

describe('HPPanel', () => {
  const mockHPStats: HPStats = {
    maxHp: 1205,
    regenerationPercent: 140,
    hpPerSecond: 2.8,
    absorb: 0,
    timeToFull: 430,
  };

  it('renders all HP stat bars', () => {
    render(<HPPanel stats={mockHPStats} />);

    // Should show regeneration
    expect(screen.getByText(/regeneration/i)).toBeInTheDocument();
    expect(screen.getByText('140%')).toBeInTheDocument();

    // Should show max HP
    expect(screen.getByText(/max hp/i)).toBeInTheDocument();
    expect(screen.getByText('1205')).toBeInTheDocument();
  });

  it('shows absorb bar when absorb > 0', () => {
    const statsWithAbsorb: HPStats = {
      ...mockHPStats,
      absorb: 200,
    };

    render(<HPPanel stats={statsWithAbsorb} />);
    expect(screen.getByText(/absorb/i)).toBeInTheDocument();
    expect(screen.getByText('200')).toBeInTheDocument();
  });

  it('hides absorb bar when absorb is 0', () => {
    render(<HPPanel stats={mockHPStats} />);
    expect(screen.queryByText(/absorb/i)).not.toBeInTheDocument();
  });

  it('uses green color scheme for bars', () => {
    const { container } = render(<HPPanel stats={mockHPStats} />);
    const bars = container.querySelectorAll('.bg-gradient-to-r');

    // At least one bar should have green gradient
    const hasGreenBar = Array.from(bars).some(bar =>
      bar.className.includes('from-green') && bar.className.includes('to-green')
    );
    expect(hasGreenBar).toBe(true);
  });

  it('displays tooltip with HP/s and time to full', () => {
    render(<HPPanel stats={mockHPStats} />);

    // Tooltip should contain HP/s
    const regenLabel = screen.getByText(/regeneration/i);
    expect(regenLabel).toHaveAttribute('data-tooltip');
    expect(regenLabel.getAttribute('data-tooltip')).toContain('2.8 HP/s');
  });
});
```

**Step 2: Run test to verify it fails**

Run: `cd frontend && npm test HPPanel.test.tsx`
Expected: FAIL with "Cannot find module './HPPanel'"

**Step 3: Create HPPanel component**

Create `frontend/src/components/stats/HPPanel.tsx`:

```typescript
import { StatBar } from './StatBar';
import type { HPStats } from '@/types/totals.types';

interface HPPanelProps {
  stats: HPStats;
}

export function HPPanel({ stats }: HPPanelProps) {
  const {
    maxHp,
    regenerationPercent,
    hpPerSecond,
    absorb,
    timeToFull,
  } = stats;

  // Format time to full as MM:SS
  const formatTime = (seconds: number): string => {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  return (
    <div className="space-y-2">
      <h3 className="text-sm font-semibold text-green-400 mb-3">Health</h3>

      {/* Regeneration */}
      <StatBar
        label="Regeneration"
        value={regenerationPercent}
        max={500} // Max display (500% is very high)
        cap={500}
        color="green"
        tooltip={`${regenerationPercent.toFixed(1)}% regeneration (${hpPerSecond.toFixed(2)} HP/s)\nTime to full: ${formatTime(timeToFull)}`}
      />

      {/* Max HP */}
      <StatBar
        label="Max HP"
        value={maxHp}
        max={4000} // Max display (4000 HP is very high)
        cap={4000}
        color="green"
        tooltip={`${maxHp} maximum hit points`}
        isNumeric
      />

      {/* Absorb Shield (only if > 0) */}
      {absorb > 0 && (
        <StatBar
          label="Absorb"
          value={absorb}
          max={2000} // Max display for absorb
          cap={2000}
          color="green"
          tooltip={`${absorb} absorb shield (${((absorb / maxHp) * 100).toFixed(1)}% of max HP)`}
          isNumeric
        />
      )}
    </div>
  );
}
```

**Step 4: Add color prop to StatBar (if not already present)**

Modify `frontend/src/components/stats/StatBar.tsx` to accept color prop:

```typescript
interface StatBarProps {
  label: string;
  value: number;
  max: number;
  cap: number;
  color?: 'purple' | 'cyan' | 'green' | 'blue' | 'red'; // Add color options
  tooltip?: string;
  isNumeric?: boolean; // If true, display value as number not percentage
}

export function StatBar({
  label,
  value,
  max,
  cap,
  color = 'purple', // Default to purple
  tooltip,
  isNumeric = false,
}: StatBarProps) {
  const barWidth = Math.min((value / max) * 100, 100);
  const isAtCap = value >= cap;
  const displayValue = isNumeric ? value.toFixed(0) : `${value.toFixed(1)}%`;

  // Color mapping
  const colorClasses = {
    purple: 'bg-gradient-to-r from-purple-900 to-purple-500 border-purple-500',
    cyan: 'bg-gradient-to-r from-cyan-900 to-cyan-500 border-cyan-500',
    green: 'bg-gradient-to-r from-green-900 to-green-500 border-green-500',
    blue: 'bg-gradient-to-r from-blue-900 to-blue-500 border-blue-500',
    red: 'bg-gradient-to-r from-red-900 to-red-500 border-red-500',
  };

  const barColorClass = colorClasses[color];
  const borderClass = isAtCap ? 'border-yellow-400' : colorClasses[color].split(' ')[2];

  return (
    <div className="flex items-center gap-3" data-tooltip={tooltip}>
      <span className="text-sm text-gray-300 w-32">{label}</span>
      <div className={`relative h-3 flex-1 bg-black border ${borderClass} rounded-sm`}>
        <div
          className={`h-full ${barColorClass} transition-all duration-300`}
          style={{ width: `${barWidth}%` }}
        />
      </div>
      <span className="text-sm text-gray-100 w-16 text-right">{displayValue}</span>
    </div>
  );
}
```

**Step 5: Run tests to verify they pass**

Run: `cd frontend && npm test HPPanel.test.tsx`
Expected: All tests PASS

**Step 6: Commit**

```bash
git add frontend/src/components/stats/HPPanel.tsx \
        frontend/src/components/stats/HPPanel.test.tsx \
        frontend/src/components/stats/StatBar.tsx
git commit -m "feat(epic-4.2): create HPPanel with regeneration, max HP, absorb"
```

---

## Task 3: Create EndurancePanel Component

**Files:**
- Create: `frontend/src/components/stats/EndurancePanel.tsx`
- Create: `frontend/src/components/stats/EndurancePanel.test.tsx`

**Step 1: Write failing test for EndurancePanel**

Create `frontend/src/components/stats/EndurancePanel.test.tsx`:

```typescript
import { render, screen } from '@testing-library/react';
import { EndurancePanel } from './EndurancePanel';
import type { EnduranceStats } from '@/types/totals.types';

describe('EndurancePanel', () => {
  const mockEnduranceStats: EnduranceStats = {
    maxEndurance: 100,
    recoveryNumeric: 2.08,
    recoveryPercent: 125,
    usage: 0.52,
    netRecovery: 1.56,
    isPositive: true,
    timeToFull: 48,
  };

  it('renders all endurance stat bars', () => {
    render(<EndurancePanel stats={mockEnduranceStats} />);

    expect(screen.getByText(/end recovery/i)).toBeInTheDocument();
    expect(screen.getByText('2.08/s')).toBeInTheDocument();

    expect(screen.getByText(/end usage/i)).toBeInTheDocument();
    expect(screen.getByText('0.52/s')).toBeInTheDocument();

    expect(screen.getByText(/max end/i)).toBeInTheDocument();
    expect(screen.getByText('100')).toBeInTheDocument();
  });

  it('shows positive net recovery with green indicator', () => {
    render(<EndurancePanel stats={mockEnduranceStats} />);

    const usageBar = screen.getByText(/end usage/i);
    expect(usageBar).toHaveAttribute('data-tooltip');
    expect(usageBar.getAttribute('data-tooltip')).toContain('Net: +1.56/s');
  });

  it('shows negative net recovery with red indicator', () => {
    const negativeStats: EnduranceStats = {
      ...mockEnduranceStats,
      recoveryNumeric: 1.0,
      usage: 2.0,
      netRecovery: -1.0,
      isPositive: false,
      timeToZero: 100,
    };

    render(<EndurancePanel stats={negativeStats} />);

    const usageBar = screen.getByText(/end usage/i);
    expect(usageBar.getAttribute('data-tooltip')).toContain('Net: -1.00/s');
    expect(usageBar.getAttribute('data-tooltip')).toContain('Time to zero');
  });

  it('uses blue color scheme for bars', () => {
    const { container } = render(<EndurancePanel stats={mockEnduranceStats} />);
    const bars = container.querySelectorAll('.bg-gradient-to-r');

    const hasBlueBar = Array.from(bars).some(bar =>
      bar.className.includes('from-blue') && bar.className.includes('to-blue')
    );
    expect(hasBlueBar).toBe(true);
  });
});
```

**Step 2: Run test to verify it fails**

Run: `cd frontend && npm test EndurancePanel.test.tsx`
Expected: FAIL with "Cannot find module './EndurancePanel'"

**Step 3: Create EndurancePanel component**

Create `frontend/src/components/stats/EndurancePanel.tsx`:

```typescript
import { StatBar } from './StatBar';
import type { EnduranceStats } from '@/types/totals.types';

interface EndurancePanelProps {
  stats: EnduranceStats;
}

export function EndurancePanel({ stats }: EndurancePanelProps) {
  const {
    maxEndurance,
    recoveryNumeric,
    recoveryPercent,
    usage,
    netRecovery,
    isPositive,
    timeToFull,
    timeToZero,
  } = stats;

  // Format time as MM:SS
  const formatTime = (seconds: number): string => {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  // Build tooltip for End Usage (includes net recovery)
  const usageTooltip = isPositive
    ? `${usage.toFixed(2)}/s endurance usage from toggles\nNet: +${netRecovery.toFixed(2)}/s (positive)\nTime to full: ${formatTime(timeToFull)}`
    : `${usage.toFixed(2)}/s endurance usage from toggles\nNet: ${netRecovery.toFixed(2)}/s (draining)\nTime to zero: ${formatTime(timeToZero || 0)}`;

  return (
    <div className="space-y-2">
      <h3 className="text-sm font-semibold text-blue-400 mb-3">Endurance</h3>

      {/* End Recovery */}
      <StatBar
        label="End Recovery"
        value={recoveryNumeric}
        max={10} // Max display (10/s is very high)
        cap={10}
        color="blue"
        tooltip={`${recoveryNumeric.toFixed(2)}/s endurance recovery (${recoveryPercent.toFixed(0)}%)\nTime to full: ${formatTime(timeToFull)}`}
        displayFormat={(v) => `${v.toFixed(2)}/s`}
      />

      {/* End Usage */}
      <StatBar
        label="End Usage"
        value={usage}
        max={10} // Max display
        cap={10}
        color={isPositive ? 'blue' : 'red'} // Red if negative net
        tooltip={usageTooltip}
        displayFormat={(v) => `${v.toFixed(2)}/s`}
      />

      {/* Max Endurance */}
      <StatBar
        label="Max End"
        value={maxEndurance}
        max={200} // Max display (200 is very high)
        cap={200}
        color="blue"
        tooltip={`${maxEndurance.toFixed(0)} maximum endurance`}
        isNumeric
      />
    </div>
  );
}
```

**Step 4: Add displayFormat prop to StatBar**

Modify `frontend/src/components/stats/StatBar.tsx` to accept custom display format:

```typescript
interface StatBarProps {
  label: string;
  value: number;
  max: number;
  cap: number;
  color?: 'purple' | 'cyan' | 'green' | 'blue' | 'red';
  tooltip?: string;
  isNumeric?: boolean;
  displayFormat?: (value: number) => string; // NEW: Custom formatter
}

export function StatBar({
  label,
  value,
  max,
  cap,
  color = 'purple',
  tooltip,
  isNumeric = false,
  displayFormat,
}: StatBarProps) {
  const barWidth = Math.min((value / max) * 100, 100);
  const isAtCap = value >= cap;

  // Use custom format if provided, otherwise default
  const displayValue = displayFormat
    ? displayFormat(value)
    : isNumeric
      ? value.toFixed(0)
      : `${value.toFixed(1)}%`;

  // ... rest of component unchanged
}
```

**Step 5: Run tests to verify they pass**

Run: `cd frontend && npm test EndurancePanel.test.tsx`
Expected: All tests PASS

**Step 6: Commit**

```bash
git add frontend/src/components/stats/EndurancePanel.tsx \
        frontend/src/components/stats/EndurancePanel.test.tsx \
        frontend/src/components/stats/StatBar.tsx
git commit -m "feat(epic-4.2): create EndurancePanel with recovery, usage, net recovery"
```

---

## Task 4: Create RechargePanel Component

**Files:**
- Create: `frontend/src/components/stats/RechargePanel.tsx`
- Create: `frontend/src/components/stats/RechargePanel.test.tsx`

**Step 1: Write failing test for RechargePanel**

Create `frontend/src/components/stats/RechargePanel.test.tsx`:

```typescript
import { render, screen } from '@testing-library/react';
import { RechargePanel } from './RechargePanel';
import type { RechargeStats } from '@/types/totals.types';

describe('RechargePanel', () => {
  it('renders global recharge stat', () => {
    const stats: RechargeStats = {
      globalPercent: 170,
      isCapped: false,
      permaHasten: false,
    };

    render(<RechargePanel stats={stats} />);
    expect(screen.getByText(/global recharge/i)).toBeInTheDocument();
    expect(screen.getByText('170%')).toBeInTheDocument();
  });

  it('shows perma-Hasten indicator when achieved', () => {
    const stats: RechargeStats = {
      globalPercent: 250,
      isCapped: false,
      permaHasten: true,
    };

    render(<RechargePanel stats={stats} />);

    const bar = screen.getByText(/global recharge/i);
    expect(bar).toHaveAttribute('data-tooltip');
    expect(bar.getAttribute('data-tooltip')).toContain('Perma-Hasten');
  });

  it('shows capped indicator when at cap', () => {
    const stats: RechargeStats = {
      globalPercent: 400,
      isCapped: true,
      permaHasten: true,
      uncappedPercent: 450,
    };

    render(<RechargePanel stats={stats} />);

    const bar = screen.getByText(/global recharge/i);
    expect(bar.getAttribute('data-tooltip')).toContain('capped at 400%');
    expect(bar.getAttribute('data-tooltip')).toContain('450%');
  });

  it('uses purple color scheme', () => {
    const stats: RechargeStats = {
      globalPercent: 170,
      isCapped: false,
      permaHasten: false,
    };

    const { container } = render(<RechargePanel stats={stats} />);
    const bars = container.querySelectorAll('.bg-gradient-to-r');

    const hasPurpleBar = Array.from(bars).some(bar =>
      bar.className.includes('from-purple') && bar.className.includes('to-purple')
    );
    expect(hasPurpleBar).toBe(true);
  });
});
```

**Step 2: Run test to verify it fails**

Run: `cd frontend && npm test RechargePanel.test.tsx`
Expected: FAIL with "Cannot find module './RechargePanel'"

**Step 3: Create RechargePanel component**

Create `frontend/src/components/stats/RechargePanel.tsx`:

```typescript
import { StatBar } from './StatBar';
import type { RechargeStats } from '@/types/totals.types';

interface RechargePanelProps {
  stats: RechargeStats;
}

export function RechargePanel({ stats }: RechargePanelProps) {
  const { globalPercent, isCapped, permaHasten, uncappedPercent } = stats;

  // Build tooltip
  let tooltip = `${globalPercent.toFixed(1)}% global recharge speed`;

  if (permaHasten) {
    tooltip += '\n✓ Perma-Hasten achieved!';
  }

  if (isCapped && uncappedPercent) {
    tooltip += `\nCapped at ${globalPercent.toFixed(0)}% (uncapped: ${uncappedPercent.toFixed(0)}%)`;
  }

  return (
    <div className="space-y-2">
      <h3 className="text-sm font-semibold text-purple-400 mb-3">Recharge</h3>

      {/* Global Recharge */}
      <StatBar
        label="Global Recharge"
        value={globalPercent}
        max={500} // Max display (500% is 5x speed)
        cap={400} // Most ATs cap at 400%
        color="purple"
        tooltip={tooltip}
      />

      {/* Perma-Hasten badge (if achieved) */}
      {permaHasten && (
        <div className="text-xs text-green-400 flex items-center gap-2">
          <span className="inline-block w-2 h-2 rounded-full bg-green-400"></span>
          Perma-Hasten Achieved
        </div>
      )}
    </div>
  );
}
```

**Step 4: Run tests to verify they pass**

Run: `cd frontend && npm test RechargePanel.test.tsx`
Expected: All tests PASS

**Step 5: Commit**

```bash
git add frontend/src/components/stats/RechargePanel.tsx \
        frontend/src/components/stats/RechargePanel.test.tsx
git commit -m "feat(epic-4.2): create RechargePanel with global recharge and perma-Hasten"
```

---

## Task 5: Create MiscStatsPanel Component

**Files:**
- Create: `frontend/src/components/stats/MiscStatsPanel.tsx`
- Create: `frontend/src/components/stats/MiscStatsPanel.test.tsx`

**Step 1: Write failing test for MiscStatsPanel**

Create `frontend/src/components/stats/MiscStatsPanel.test.tsx`:

```typescript
import { render, screen } from '@testing-library/react';
import { MiscStatsPanel } from './MiscStatsPanel';
import type { MiscBuffStats } from '@/types/totals.types';

describe('MiscStatsPanel', () => {
  const mockStats: MiscBuffStats = {
    accuracy: 15,
    tohit: 10,
    damagePercent: 125,
  };

  it('renders all misc stat bars', () => {
    render(<MiscStatsPanel stats={mockStats} />);

    expect(screen.getByText(/accuracy/i)).toBeInTheDocument();
    expect(screen.getByText('15%')).toBeInTheDocument();

    expect(screen.getByText(/tohit/i)).toBeInTheDocument();
    expect(screen.getByText('10%')).toBeInTheDocument();

    expect(screen.getByText(/damage/i)).toBeInTheDocument();
    expect(screen.getByText('125%')).toBeInTheDocument();
  });

  it('uses appropriate color scheme', () => {
    const { container } = render(<MiscStatsPanel stats={mockStats} />);
    const bars = container.querySelectorAll('.bg-gradient-to-r');

    // Should have at least 3 bars
    expect(bars.length).toBeGreaterThanOrEqual(3);
  });
});
```

**Step 2: Run test to verify it fails**

Run: `cd frontend && npm test MiscStatsPanel.test.tsx`
Expected: FAIL with "Cannot find module './MiscStatsPanel'"

**Step 3: Create MiscStatsPanel component**

Create `frontend/src/components/stats/MiscStatsPanel.tsx`:

```typescript
import { StatBar } from './StatBar';
import type { MiscBuffStats } from '@/types/totals.types';

interface MiscStatsPanelProps {
  stats: MiscBuffStats;
}

export function MiscStatsPanel({ stats }: MiscStatsPanelProps) {
  const { accuracy, tohit, damagePercent } = stats;

  return (
    <div className="space-y-2">
      <h3 className="text-sm font-semibold text-gray-400 mb-3">Misc Buffs</h3>

      {/* Accuracy */}
      <StatBar
        label="Accuracy"
        value={accuracy}
        max={200} // Max display
        cap={200}
        color="cyan"
        tooltip={`${accuracy.toFixed(1)}% accuracy bonus (base 0%)`}
      />

      {/* ToHit */}
      <StatBar
        label="ToHit"
        value={tohit}
        max={100} // ToHit typically capped at 95%
        cap={95}
        color="cyan"
        tooltip={`${tohit.toFixed(1)}% tohit bonus (base 0%)`}
      />

      {/* Damage */}
      <StatBar
        label="Damage"
        value={damagePercent}
        max={500} // Damage can go very high with set bonuses
        cap={400} // Most ATs cap around 400%
        color="red"
        tooltip={`${damagePercent.toFixed(1)}% total damage (base 100%)`}
      />
    </div>
  );
}
```

**Step 4: Run tests to verify they pass**

Run: `cd frontend && npm test MiscStatsPanel.test.tsx`
Expected: All tests PASS

**Step 5: Commit**

```bash
git add frontend/src/components/stats/MiscStatsPanel.tsx \
        frontend/src/components/stats/MiscStatsPanel.test.tsx
git commit -m "feat(epic-4.2): create MiscStatsPanel with accuracy, tohit, damage"
```

---

## Task 6: Extend TotalsPanel to Include New Panels

**Files:**
- Modify: `frontend/src/components/stats/TotalsPanel.tsx`
- Modify: `frontend/src/components/stats/TotalsPanel.test.tsx`

**Step 1: Write test for extended TotalsPanel**

Add to `frontend/src/components/stats/TotalsPanel.test.tsx`:

```typescript
describe('TotalsPanel - Epic 4.2 Extensions', () => {
  const mockTotalsWithHP: CalculatedTotals = {
    defense: mockDefenseStats,
    resistance: mockResistanceStats,
    hp: {
      maxHp: 1205,
      regenerationPercent: 140,
      hpPerSecond: 2.8,
      absorb: 0,
      timeToFull: 430,
    },
    endurance: {
      maxEndurance: 100,
      recoveryNumeric: 2.08,
      recoveryPercent: 125,
      usage: 0.52,
      netRecovery: 1.56,
      isPositive: true,
      timeToFull: 48,
    },
    recharge: {
      globalPercent: 170,
      isCapped: false,
      permaHasten: false,
    },
    buffs: {
      accuracy: 15,
      tohit: 10,
      damagePercent: 125,
    },
  };

  beforeEach(() => {
    // Mock characterStore to return totals with HP/Endurance/Recharge
    useCharacterStore.setState({ totals: mockTotalsWithHP });
  });

  it('renders HP panel when totals include HP data', () => {
    render(<TotalsPanel />);
    expect(screen.getByText(/health/i)).toBeInTheDocument();
    expect(screen.getByText('1205')).toBeInTheDocument(); // Max HP
  });

  it('renders Endurance panel when totals include endurance data', () => {
    render(<TotalsPanel />);
    expect(screen.getByText(/endurance/i)).toBeInTheDocument();
    expect(screen.getByText('2.08/s')).toBeInTheDocument(); // Recovery
  });

  it('renders Recharge panel when totals include recharge data', () => {
    render(<TotalsPanel />);
    expect(screen.getByText(/recharge/i)).toBeInTheDocument();
    expect(screen.getByText('170%')).toBeInTheDocument();
  });

  it('renders Misc Stats panel when totals include buff data', () => {
    render(<TotalsPanel />);
    expect(screen.getByText(/misc buffs/i)).toBeInTheDocument();
    expect(screen.getByText('15%')).toBeInTheDocument(); // Accuracy
  });
});
```

**Step 2: Run test to verify it fails**

Run: `cd frontend && npm test TotalsPanel.test.tsx`
Expected: FAIL - new panels not rendered

**Step 3: Modify TotalsPanel to include new panels**

Modify `frontend/src/components/stats/TotalsPanel.tsx`:

```typescript
import { useCharacterStore } from '@/stores/characterStore';
import { useCalculations } from '@/hooks/useCalculations';
import { DefensePanel } from './DefensePanel';
import { ResistancePanel } from './ResistancePanel';
import { HPPanel } from './HPPanel'; // NEW
import { EndurancePanel } from './EndurancePanel'; // NEW
import { RechargePanel } from './RechargePanel'; // NEW
import { MiscStatsPanel } from './MiscStatsPanel'; // NEW
import { LoadingSpinner } from '@/components/ui/LoadingSpinner';
import { ErrorMessage } from '@/components/ui/ErrorMessage';

export function TotalsPanel() {
  const { totals, isCalculating } = useCharacterStore();
  const { mutate: recalculate, isError, error } = useCalculations();

  // Auto-recalculate on mount if no totals
  useEffect(() => {
    if (!totals) {
      recalculate();
    }
  }, [totals, recalculate]);

  if (isCalculating) {
    return <LoadingSpinner />;
  }

  if (isError) {
    return (
      <ErrorMessage
        message="Failed to calculate totals"
        onRetry={() => recalculate()}
      />
    );
  }

  if (!totals) {
    return null;
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 p-4">
      {/* Defense Panel (Epic 4.1) */}
      <DefensePanel stats={totals.defense} />

      {/* Resistance Panel (Epic 4.1) */}
      <ResistancePanel stats={totals.resistance} />

      {/* HP Panel (Epic 4.2) */}
      {totals.hp && <HPPanel stats={totals.hp} />}

      {/* Endurance Panel (Epic 4.2) */}
      {totals.endurance && <EndurancePanel stats={totals.endurance} />}

      {/* Recharge Panel (Epic 4.2) */}
      {totals.recharge && <RechargePanel stats={totals.recharge} />}

      {/* Misc Stats Panel (Epic 4.2) */}
      {totals.buffs && <MiscStatsPanel stats={totals.buffs} />}
    </div>
  );
}
```

**Step 4: Run tests to verify they pass**

Run: `cd frontend && npm test TotalsPanel.test.tsx`
Expected: All tests PASS

**Step 5: Commit**

```bash
git add frontend/src/components/stats/TotalsPanel.tsx \
        frontend/src/components/stats/TotalsPanel.test.tsx
git commit -m "feat(epic-4.2): extend TotalsPanel to include HP, Endurance, Recharge, Misc panels"
```

---

## Task 7: Update characterStore Recalculation to Include New Data

**Files:**
- Modify: `frontend/src/stores/characterStore.ts`

**Step 1: Verify recalculate() action handles new totals data**

The `recalculate()` action from Epic 4.1 should already handle the extended CalculatedTotals interface. Verify it updates all totals fields:

```typescript
// In characterStore.ts (from Epic 4.1)
recalculate: async () => {
  set({ isCalculating: true });
  try {
    const buildData = get().exportBuild();
    const response = await fetch('/api/calculations/totals', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(buildData),
    });
    const totals: CalculatedTotals = await response.json();

    // This should now include hp, endurance, recharge, buffs from Epic 4.2
    set({
      totals,  // Complete CalculatedTotals with all Epic 4.1 + 4.2 data
      isCalculating: false,
      lastCalculated: new Date(),
    });
  } catch (error) {
    console.error('Calculation failed:', error);
    set({ isCalculating: false });
  }
},
```

**Step 2: Add tests for new totals fields**

Add to `frontend/src/stores/characterStore.test.ts`:

```typescript
describe('characterStore - Epic 4.2 Extensions', () => {
  it('recalculate() updates HP totals', async () => {
    const mockResponse: CalculatedTotals = {
      defense: { /* ... */ },
      resistance: { /* ... */ },
      hp: {
        maxHp: 1205,
        regenerationPercent: 140,
        hpPerSecond: 2.8,
        absorb: 0,
        timeToFull: 430,
      },
      endurance: { /* ... */ },
      recharge: { /* ... */ },
      buffs: { /* ... */ },
    };

    global.fetch = vi.fn().mockResolvedValue({
      ok: true,
      json: async () => mockResponse,
    });

    const { result } = renderHook(() => useCharacterStore());
    await act(async () => {
      await result.current.recalculate();
    });

    expect(result.current.totals?.hp).toEqual(mockResponse.hp);
  });

  it('recalculate() updates endurance totals', async () => {
    // Similar test for endurance
  });

  it('recalculate() updates recharge totals', async () => {
    // Similar test for recharge
  });

  it('recalculate() updates misc buff totals', async () => {
    // Similar test for buffs
  });
});
```

**Step 3: Run tests**

Run: `cd frontend && npm test characterStore.test.ts`
Expected: All tests PASS

**Step 4: Commit**

```bash
git add frontend/src/stores/characterStore.test.ts
git commit -m "test(epic-4.2): add tests for HP/Endurance/Recharge totals in characterStore"
```

---

## Task 8: Integration Testing

**Files:**
- Create: `frontend/src/components/stats/__tests__/TotalsPanel.integration.test.tsx`

**Step 1: Write integration test**

Create `frontend/src/components/stats/__tests__/TotalsPanel.integration.test.tsx`:

```typescript
import { render, screen, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { TotalsPanel } from '../TotalsPanel';
import { useCharacterStore } from '@/stores/characterStore';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: { retry: false },
    mutations: { retry: false },
  },
});

function wrapper({ children }: { children: React.ReactNode }) {
  return (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
}

describe('TotalsPanel Integration', () => {
  beforeEach(() => {
    // Reset store
    useCharacterStore.setState({
      totals: null,
      isCalculating: false
    });
  });

  it('displays all stat panels with calculated data', async () => {
    const mockTotals: CalculatedTotals = {
      defense: {
        smashing: 45.0,
        lethal: 45.0,
        fire: 30.5,
        cold: 30.5,
        energy: 35.0,
        negative: 20.0,
        toxic: 0.0,
        psionic: 15.0,
        melee: 45.0,
        ranged: 35.0,
        aoe: 30.0,
      },
      resistance: {
        smashing: 60.0,
        lethal: 60.0,
        fire: 40.0,
        cold: 40.0,
        energy: 30.0,
        negative: 20.0,
        toxic: 10.0,
        psionic: 5.0,
      },
      hp: {
        maxHp: 1807,
        regenerationPercent: 240,
        hpPerSecond: 8.5,
        absorb: 300,
        timeToFull: 212,
      },
      endurance: {
        maxEndurance: 110,
        recoveryNumeric: 3.5,
        recoveryPercent: 150,
        usage: 1.2,
        netRecovery: 2.3,
        isPositive: true,
        timeToFull: 31,
      },
      recharge: {
        globalPercent: 252.5,
        isCapped: false,
        permaHasten: true,
      },
      buffs: {
        accuracy: 25,
        tohit: 15,
        damagePercent: 165,
      },
    };

    // Mock API response
    global.fetch = vi.fn().mockResolvedValue({
      ok: true,
      json: async () => mockTotals,
    });

    render(<TotalsPanel />, { wrapper });

    // Wait for calculation to complete
    await waitFor(() => {
      expect(screen.queryByText(/loading/i)).not.toBeInTheDocument();
    });

    // Verify Defense panel
    expect(screen.getByText('45.0%')).toBeInTheDocument(); // Smashing defense

    // Verify Resistance panel
    expect(screen.getByText('60.0%')).toBeInTheDocument(); // Smashing resistance

    // Verify HP panel
    expect(screen.getByText('1807')).toBeInTheDocument(); // Max HP
    expect(screen.getByText('240%')).toBeInTheDocument(); // Regen
    expect(screen.getByText('300')).toBeInTheDocument(); // Absorb

    // Verify Endurance panel
    expect(screen.getByText('3.50/s')).toBeInTheDocument(); // Recovery
    expect(screen.getByText('1.20/s')).toBeInTheDocument(); // Usage
    expect(screen.getByText('110')).toBeInTheDocument(); // Max End

    // Verify Recharge panel
    expect(screen.getByText('252.5%')).toBeInTheDocument(); // Global recharge
    expect(screen.getByText(/perma-hasten achieved/i)).toBeInTheDocument();

    // Verify Misc Stats panel
    expect(screen.getByText('25%')).toBeInTheDocument(); // Accuracy
    expect(screen.getByText('15%')).toBeInTheDocument(); // ToHit
    expect(screen.getByText('165%')).toBeInTheDocument(); // Damage
  });

  it('handles API error gracefully', async () => {
    global.fetch = vi.fn().mockRejectedValue(new Error('API Error'));

    render(<TotalsPanel />, { wrapper });

    await waitFor(() => {
      expect(screen.getByText(/failed to calculate/i)).toBeInTheDocument();
      expect(screen.getByRole('button', { name: /retry/i })).toBeInTheDocument();
    });
  });

  it('shows loading state during calculation', () => {
    useCharacterStore.setState({ isCalculating: true });

    render(<TotalsPanel />, { wrapper });

    expect(screen.getByText(/loading/i)).toBeInTheDocument();
  });
});
```

**Step 2: Run integration tests**

Run: `cd frontend && npm test TotalsPanel.integration.test.tsx`
Expected: All tests PASS

**Step 3: Commit**

```bash
git add frontend/src/components/stats/__tests__/TotalsPanel.integration.test.tsx
git commit -m "test(epic-4.2): add integration tests for complete TotalsPanel"
```

---

## Task 9: Visual Verification & Documentation

**Files:**
- Create: `frontend/src/components/stats/README.md`

**Step 1: Create component documentation**

Create `frontend/src/components/stats/README.md`:

```markdown
# Stats Components

Components for displaying character build totals (defense, resistance, HP, endurance, recharge, misc buffs).

## Epic 4.1 Components

### StatBar
Reusable horizontal stat bar with label, value, and gradient background.

**Props:**
- `label: string` - Stat name (e.g., "Smashing Defense")
- `value: number` - Current value
- `max: number` - Maximum value for scale
- `cap: number` - Archetype cap (shows visual indicator when reached)
- `color?: 'purple' | 'cyan' | 'green' | 'blue' | 'red'` - Color scheme
- `tooltip?: string` - Tooltip text on hover
- `isNumeric?: boolean` - Display as number (not percentage)
- `displayFormat?: (value: number) => string` - Custom value formatter

**Usage:**
```tsx
<StatBar
  label="Smashing Defense"
  value={45.0}
  max={100}
  cap={45}
  color="purple"
  tooltip="45.0% smashing defense (at soft-cap)"
/>
```

### DefensePanel
Displays 11 defense values (8 typed + 3 positional) using purple bars.

### ResistancePanel
Displays 8 typed resistance values using cyan bars.

### TotalsPanel
Container component that displays all stat panels and handles auto-recalculation.

## Epic 4.2 Components

### HPPanel
Displays health stats using green bars:
- Regeneration (% and HP/s)
- Max HP (numeric)
- Absorb shield (if > 0)

**Color:** Green (`from-green-900 to-green-500`)

### EndurancePanel
Displays endurance stats using blue bars:
- End Recovery (/s and %)
- End Usage (/s with net recovery calculation)
- Max Endurance (numeric)

**Color:** Blue (`from-blue-900 to-blue-500`)
**Special:** Usage bar turns red if net recovery is negative

### RechargePanel
Displays global recharge using purple bar:
- Global Recharge (%)
- Perma-Hasten indicator (if >= 170%)

**Color:** Purple (`from-purple-900 to-purple-500`)

### MiscStatsPanel
Displays misc buff stats using cyan/red bars:
- Accuracy (%)
- ToHit (%)
- Damage (%)

**Colors:** Cyan for accuracy/tohit, red for damage

## State Management

All components consume data from `characterStore.totals` (Zustand store).

**Recalculation:**
- Automatic: Triggered on power selection, enhancement slotting, level change
- Manual: Via `recalculate()` action
- Debounced: 500ms delay to batch rapid changes

**API Endpoint:** `POST /api/calculations/totals`

## Testing

Run all tests:
```bash
npm test stats/
```

Run specific component tests:
```bash
npm test HPPanel.test.tsx
npm test EndurancePanel.test.tsx
npm test RechargePanel.test.tsx
```

Run integration tests:
```bash
npm test TotalsPanel.integration.test.tsx
```

## Visual Verification

Compare with MidsReborn screenshots:
- `view-total-window.png` - Full totals window with all sections
- `total-screen-1.png` - Compact inline totals

**Color Schemes:**
- Purple: Defense, Recharge
- Cyan: Resistance, Accuracy, ToHit
- Green: HP, Regeneration
- Blue: Endurance
- Red: Damage, Negative net recovery

## Performance

- Bar width animations: 300ms transition (`transition-all duration-300`)
- Auto-calculation debounce: 500ms
- No caching on totals (always recalculate for accuracy)
```

**Step 2: Commit documentation**

```bash
git add frontend/src/components/stats/README.md
git commit -m "docs(epic-4.2): add stats components documentation"
```

---

## Task 10: Create PLAN-SUMMARY

**Files:**
- Create: `docs/frontend/plans/PLAN-SUMMARY-epic-4.2.md`

**Step 1: Create epic summary**

Create `docs/frontend/plans/PLAN-SUMMARY-epic-4.2.md`:

```markdown
# Epic 4.2: HP, Endurance, Recharge Displays - Summary

**Date**: 2025-11-20
**Status**: Planning Complete
**Epic**: 4.2 - HP, Endurance, Recharge Displays
**Detailed Plan**: 2025-11-20-epic-4.2-hp-endurance-recharge.md

---

## What This Epic Accomplishes

Epic 4.2 extends the build totals display system from Epic 4.1 by adding four new stat panels: **HP Panel** (regeneration, max HP, absorb), **Endurance Panel** (recovery, usage, net recovery with time-to-full/zero calculations), **Recharge Panel** (global recharge with perma-Hasten indicator), and **Misc Stats Panel** (accuracy, tohit, damage bonuses).

**Key Features:**
1. **HP Panel**: 2-3 green bars showing regeneration %, max HP, and absorb shield
2. **Endurance Panel**: 3 blue bars showing recovery/s, usage/s, max endurance with net recovery calculation
3. **Recharge Panel**: 1 purple bar showing global recharge % with perma-Hasten achievement badge
4. **Misc Stats Panel**: 3 bars showing accuracy, tohit, and damage percentage bonuses

Unlike Epic 4.1 which created the foundation (StatBar, TotalsPanel), Epic 4.2 focuses on extending the system with new stat types while maintaining visual consistency and reusing existing components.

---

## Key Components Created

### React Components (4 new panels)

**HPPanel** (`components/stats/HPPanel.tsx`):
- Displays health statistics with green color scheme
- Regeneration bar (%, base 100%)
- Max HP bar (numeric value)
- Absorb shield bar (conditional, only if > 0)
- Tooltip shows HP/s and time to full

**EndurancePanel** (`components/stats/EndurancePanel.tsx`):
- Displays endurance statistics with blue color scheme
- End Recovery bar (/s, shows as numeric + percentage in tooltip)
- End Usage bar (/s, turns red if net negative)
- Max Endurance bar (numeric value)
- Complex net recovery calculation (Recovery - Usage)
- Tooltips show time to full or time to zero

**RechargePanel** (`components/stats/RechargePanel.tsx`):
- Displays global recharge with purple color scheme
- Global Recharge bar (%, base 100%)
- Perma-Hasten achievement badge (if >= 170%)
- Shows capped vs uncapped values in tooltip

**MiscStatsPanel** (`components/stats/MiscStatsPanel.tsx`):
- Displays misc buff statistics
- Accuracy bar (%, cyan)
- ToHit bar (%, cyan)
- Damage bar (%, red)

### TypeScript Types (extended)

**totals.types.ts** (extended from Epic 4.1):
- `HPStats` interface (maxHp, regenerationPercent, hpPerSecond, absorb, timeToFull)
- `EnduranceStats` interface (maxEndurance, recoveryNumeric, recoveryPercent, usage, netRecovery, isPositive, timeToFull, timeToZero)
- `RechargeStats` interface (globalPercent, isCapped, permaHasten, uncappedPercent)
- `MiscBuffStats` interface (accuracy, tohit, damagePercent)
- Extended `CalculatedTotals` to include hp, endurance, recharge, buffs

### Modified Components (1)

**TotalsPanel** (`components/stats/TotalsPanel.tsx`):
- Extended to render HP, Endurance, Recharge, Misc Stats panels
- Maintains 2-column responsive grid layout
- Conditional rendering (only show panels if data exists)
- Reuses auto-recalculation system from Epic 4.1

---

## State Management Approach

### TanStack Query (Server State)

**Endpoint**: `POST /api/calculations/totals` (already exists from Epic 1.4)

**Extended Response**:
```typescript
{
  defense: { /* from Epic 4.1 */ },
  resistance: { /* from Epic 4.1 */ },
  hp: {
    maxHp: 1205,
    regenerationPercent: 140,
    hpPerSecond: 2.8,
    absorb: 0,
    timeToFull: 430
  },
  endurance: {
    maxEndurance: 100,
    recoveryNumeric: 2.08,
    recoveryPercent: 125,
    usage: 0.52,
    netRecovery: 1.56,
    isPositive: true,
    timeToFull: 48
  },
  recharge: {
    globalPercent: 170,
    isCapped: false,
    permaHasten: false
  },
  buffs: {
    accuracy: 15,
    tohit: 10,
    damagePercent: 125
  }
}
```

**Caching Strategy**: No caching (same as Epic 4.1) - always recalculate for accuracy

### Zustand (Client State)

**Store**: `characterStore` (reuse from Epic 4.1)

**State**: Already has `totals: CalculatedTotals | null` field which now includes Epic 4.2 data

**Actions**: Reuse `recalculate()` action from Epic 4.1 - it automatically handles extended CalculatedTotals interface

### Derived State

**Net Recovery**:
```typescript
const netRecovery = recoveryNumeric - usage;
const isPositive = netRecovery > 0;
```

**Perma-Hasten**:
```typescript
const permaHasten = globalPercent >= 170; // Simplified threshold
```

**Bar Colors**:
```typescript
const enduranceUsageColor = isPositive ? 'blue' : 'red';
```

---

## API Integration

### Backend Endpoints Used

1. **POST /api/calculations/totals** - Already exists (Epic 1.4)
   - Extended to return HP, Endurance, Recharge, Buffs data
   - Request format unchanged (BuildData)
   - Response includes new fields

**No new API endpoints needed** - Epic 4.2 purely extends the response of the existing totals endpoint.

---

## Implementation Tasks

### Phase 1: Core Components (Tasks 1-5)

1. ✅ Create TypeScript types (HPStats, EnduranceStats, RechargeStats, MiscBuffStats)
2. ✅ Create HPPanel with regeneration, max HP, absorb
3. ✅ Create EndurancePanel with recovery, usage, net recovery
4. ✅ Create RechargePanel with global recharge and perma-Hasten indicator
5. ✅ Create MiscStatsPanel with accuracy, tohit, damage

### Phase 2: Integration (Tasks 6-7)

6. ✅ Extend TotalsPanel to include new panels
7. ✅ Verify characterStore recalculation handles new data

### Phase 3: Testing (Task 8-9)

8. ✅ Integration testing (full TotalsPanel with all Epic 4.1 + 4.2 panels)
9. ✅ Visual verification and documentation

### Phase 4: Summary (Task 10)

10. ✅ Create this PLAN-SUMMARY document

**Total Estimated Time**: 4-6 hours

---

## Acceptance Criteria

### Functional

✅ **HP display works**:
- Regeneration shows as percentage (base 100%, e.g., 140% = +40% regen)
- Max HP shows as numeric value
- Absorb shield shows only when > 0
- Tooltip shows HP/s and time to full

✅ **Endurance display works**:
- Recovery shows as /s (numeric) with % in tooltip
- Usage shows as /s with net recovery in tooltip
- Net recovery calculated correctly (recovery - usage)
- Usage bar turns red if net recovery is negative
- Time to full shown if positive, time to zero if negative

✅ **Recharge display works**:
- Global recharge shows as percentage (base 100%, e.g., 170% = +70%)
- Perma-Hasten badge shows when achieved (>= 170%)
- Capped value shown with uncapped in tooltip if exceeds cap

✅ **Misc Stats display works**:
- Accuracy, ToHit, Damage all display correctly
- Appropriate color schemes (cyan for accuracy/tohit, red for damage)

✅ **State management works**:
- Totals auto-recalculate when build changes (reuses Epic 4.1 system)
- Loading state shows during calculation
- Error state shows on failure with retry button
- All Epic 4.1 + 4.2 panels render together

### Visual

✅ **Colors match MidsReborn**:
- Green: HP, Regeneration
- Blue: Endurance
- Purple: Recharge
- Cyan: Accuracy, ToHit
- Red: Damage, Negative net recovery

✅ **Layout matches MidsReborn**:
- 2-column grid on desktop (Defense/Resistance left, HP/Endurance/Recharge right)
- 1-column stack on mobile
- Section headers for each panel
- Consistent spacing and alignment

✅ **Typography and formatting**:
- Percentages: "140%" (1 decimal if needed)
- Numeric values: "1205" (no decimals for HP)
- Per-second values: "2.08/s" (2 decimals)
- Labels left-aligned, values right-aligned

### Technical

✅ **TypeScript strict mode**:
- No `any` types
- All props typed
- All state typed
- All API responses typed (extended CalculatedTotals)

✅ **Test coverage**:
- HPPanel: 5+ tests
- EndurancePanel: 5+ tests
- RechargePanel: 4+ tests
- MiscStatsPanel: 2+ tests
- TotalsPanel integration: 3+ tests
- All tests passing

✅ **Code quality**:
- ESLint passing
- Prettier formatting applied
- No console warnings
- Accessible (ARIA labels, keyboard navigation)
- Reuses StatBar component (DRY principle)

---

## Deferred Features

**Epic 4.3** (Visual Aids - Improved):
- Enhanced stat visualizations beyond basic bars
- Comparison tooltips (before/after slotting)
- Mini stat cards for quick view
- Collapsible sections

**Future Enhancements**:
- Detailed per-power breakdowns (which powers contribute to each stat)
- Historical comparison (compare current build to previous versions)
- Export totals to clipboard
- Time-series graphs for stat progression by level

---

## Next Epic Preview

**Epic 4.3**: Visual Aids (Improved)

**Will build on Epic 4.2**:
- Enhance existing stat visualizations
- Add comparison tooltips showing before/after values
- Create mini stat cards for dashboard view
- Implement collapsible sections for space efficiency

**Prerequisites Met by Epic 4.2**:
- ✅ Complete stat display system (Defense, Resistance, HP, Endurance, Recharge, Misc)
- ✅ Consistent visual design (colors, layouts, tooltips)
- ✅ Reusable StatBar component
- ✅ TotalsPanel structure ready for enhancements
- ✅ Auto-recalculation system

---

## Key Design Decisions

### 1. Reuse StatBar Component

**Rationale**: Epic 4.1 created a flexible StatBar component that works for all stat types (defense, resistance, HP, endurance, recharge). Reusing it maintains consistency and reduces code duplication.

**Impact**: All Epic 4.2 panels use the same StatBar component with different color props.

### 2. Net Recovery Calculation in EndurancePanel

**Rationale**: MidsReborn shows net recovery (recovery - usage) in the End Usage tooltip. This is critical for players to understand if their build is sustainable.

**Impact**: EndurancePanel calculates and displays net recovery, colors usage bar based on sign (blue if positive, red if negative).

### 3. Perma-Hasten Achievement Badge

**Rationale**: Perma-Hasten (permanent Hasten uptime) is a common build goal. Visual indicator helps players know if they've achieved it.

**Impact**: RechargePanel shows green badge when globalPercent >= 170% (simplified threshold, actual calculation more complex).

### 4. Conditional Absorb Display

**Rationale**: Absorb shield is rare (only some builds have it). Showing an empty bar for 0 absorb wastes space.

**Impact**: HPPanel only renders Absorb bar if value > 0.

### 5. Custom Display Formatters

**Rationale**: Different stats need different formats (percentages, numeric values, /s values). Custom formatters allow flexibility without duplicating StatBar component.

**Impact**: Added `displayFormat` prop to StatBar, used for endurance recovery/usage ("/s" format).

---

## Summary

Epic 4.2 delivers the **HP, Endurance, Recharge, and Misc Stats display system** for Mids Hero Web:

**Components Created** (4 new panels):
- HPPanel - Health stats with green bars (regeneration, max HP, absorb)
- EndurancePanel - Endurance stats with blue bars (recovery, usage, net recovery)
- RechargePanel - Recharge stats with purple bar (global recharge, perma-Hasten)
- MiscStatsPanel - Misc buffs with cyan/red bars (accuracy, tohit, damage)

**State Management**:
- Reuses characterStore.totals from Epic 4.1
- Extends CalculatedTotals interface with hp, endurance, recharge, buffs fields
- Reuses auto-recalculation system from Epic 4.1

**Visual Design**:
- Green bars for HP/regeneration
- Blue bars for endurance (red if negative net recovery)
- Purple bars for recharge
- Cyan bars for accuracy/tohit, red for damage
- Consistent layout with Epic 4.1 (2-column responsive grid)

**API Integration**:
- Extends existing POST /api/calculations/totals response
- No new endpoints needed

This foundation completes the core stat display system and enables Epic 4.3 (visual enhancements).

---

**Status**: ✅ Planning Complete - Ready for Execution
**Components**: 4 panels + 4 interfaces + TotalsPanel extension
**Tests**: ~25 tests total
**Estimated Time**: 4-6 hours
**Dependencies**: Epic 4.1 complete ✅
**Next**: Execute implementation, visual verification, checkpoint generation
```

**Step 2: Commit summary**

```bash
git add docs/frontend/plans/PLAN-SUMMARY-epic-4.2.md
git commit -m "docs(epic-4.2): create plan summary"
```

---

## Acceptance Criteria

**Functional Requirements:**
- ✅ HPPanel displays regeneration, max HP, and absorb (conditional)
- ✅ EndurancePanel displays recovery, usage, max endurance with net recovery
- ✅ RechargePanel displays global recharge with perma-Hasten indicator
- ✅ MiscStatsPanel displays accuracy, tohit, damage
- ✅ All panels integrate into TotalsPanel
- ✅ Auto-recalculation works for new stats
- ✅ Tooltips show detailed information
- ✅ Colors match MidsReborn (green/blue/purple/cyan/red)

**Visual Requirements:**
- ✅ 2-column responsive grid layout
- ✅ Consistent spacing and alignment
- ✅ Smooth bar width animations (300ms)
- ✅ Appropriate color schemes per stat type
- ✅ Section headers for each panel

**Technical Requirements:**
- ✅ TypeScript strict mode (no `any` types)
- ✅ Test coverage (25+ tests total)
- ✅ ESLint/Prettier passing
- ✅ No console warnings
- ✅ Accessible (ARIA labels, keyboard navigation)
- ✅ Reuses StatBar component (DRY principle)

---

## References

**MidsReborn Analysis:**
- `docs/frontend/analysis/MIDSREBORN-UI-ANALYSIS-epic-4.2.md` (1,029 lines)

**Previous Epic:**
- `docs/frontend/plans/PLAN-SUMMARY-epic-4.1.md` (StatBar, TotalsPanel foundation)

**Calculation Specs:**
- `docs/midsreborn/calculations/06-power-endurance-recovery.md` (Endurance mechanics)
- `docs/midsreborn/calculations/21-build-totals-recharge.md` (Global recharge calculation)

**Screenshots:**
- `view-total-window.png` - Full totals window with HP/Endurance sections
- `total-screen-1.png` - Compact totals display

---

**Plan Status**: ✅ Complete - Ready for Execution
**Total Tasks**: 10 (TypeScript types, 4 panels, TotalsPanel extension, testing, docs, summary)
**Estimated Time**: 4-6 hours
**Dependencies**: Epic 4.1 complete
